name: IDP E2E Tests

on:
  pull_request:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

concurrency:
  group: idp-e2e-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      pull-requests: write
      checks: write
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements-dev.txt'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      - name: Set up test cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: fawkes-test
          wait: 120s

      - name: Build & load inspector image (local)
        run: |
          docker build -t ghcr.io/paruff/mcp-k8s-server:ci ./services/mcp-k8s-server
          kind load docker-image ghcr.io/paruff/mcp-k8s-server:ci --name fawkes-test

      - name: Sanity check cluster
        run: |
          kubectl cluster-info
          kubectl get nodes -o wide

      - name: Bootstrap minimal platform (namespace + policies + inspector)
        run: |
          set -e
          # Namespace
          kubectl get ns fawkes || kubectl create namespace fawkes
          # Policies (LimitRange / ResourceQuota)
          if [ -f infra/kubernetes/namespace-policies.yaml ]; then
            kubectl apply -f infra/kubernetes/namespace-policies.yaml
          fi
          # Inspector deployment (kustomize)
          kubectl apply -k infra/kubernetes/apps/mcp-k8s-server
          # Patch image to use locally built tag
          kubectl -n fawkes set image deployment/mcp-k8s-server server=ghcr.io/paruff/mcp-k8s-server:ci
          # Diagnostics before rollout wait
          kubectl -n fawkes get deploy mcp-k8s-server -o yaml | sed -n '1,120p'
          kubectl -n fawkes get pods -l app=mcp-k8s-server -o wide || true
          kubectl -n fawkes get events --sort-by=.metadata.creationTimestamp | tail -n 40 || true
          # Wait for pod readiness (ignore if replicas=0)
          if kubectl -n fawkes get deploy mcp-k8s-server >/dev/null 2>&1; then
            REPLICAS=$(kubectl -n fawkes get deploy mcp-k8s-server -o jsonpath='{.spec.replicas}')
            if [ "$REPLICAS" != "0" ]; then
              kubectl -n fawkes rollout status deployment/mcp-k8s-server --timeout=300s
            fi
          fi

      - name: Prepare reports directory
        run: |
          mkdir -p reports

      - name: Run smoke tests (cluster sanity)
        run: |
          set -e
          if [ ! -f tests/bdd/test_smoke.py ]; then
            echo "No smoke test file found; creating zero-test report"
            echo '<testsuite name="smoke" tests="0" failures="0" errors="0" skipped="0" />' > reports/smoke-tests.xml
          else
            # Run only smoke-marked tests; on collection error still produce XML
            pytest -q tests/bdd/test_smoke.py -m smoke --junit-xml=reports/smoke-tests.xml || {
              echo "Smoke tests failed; preserving exit code after report upload"
              EXIT=$?
              # Ensure report exists
              [ -f reports/smoke-tests.xml ] || echo '<testsuite name="smoke" tests="0" failures="1" errors="0" skipped="0" />' > reports/smoke-tests.xml
              exit $EXIT
            }
          fi

      - name: Run full E2E suite (placeholder)
        if: github.event_name != 'pull_request'
        run: |
          echo "Full E2E placeholder: skipping until platform bootstrap is CI-ready."
          # Intentionally noop with success
          echo '<testsuite name="e2e" tests="0" />' > reports/e2e-placeholder.xml
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ github.run_id }}
          path: reports/
          retention-days: 7

      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: reports/*.xml

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… Smoke tests executed. JUnit XML uploaded as artifact: test-reports-${process.env.GITHUB_RUN_ID}.`
            });
