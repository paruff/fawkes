name: IDP E2E Tests

on:
  pull_request:
    paths:
      - '.github/workflows/idp-e2e-tests.yml'
      - 'infra/**'
      - 'tests/**'
      - 'scripts/**'
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      
      - name: Set up test cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: fawkes-test
          wait: 120s

      - name: Sanity check cluster
        run: |
          kubectl cluster-info
          kubectl get nodes -o wide
      
      - name: Prepare reports directory
        run: |
          mkdir -p reports
      
      - name: Run smoke tests (BDD subset)
        run: |
          # Run only our minimal smoke test to avoid collecting incomplete BDD scenarios
          pytest tests/bdd/test_smoke.py -m smoke --junit-xml=reports/smoke-tests.xml
      
      - name: Run full E2E suite (placeholder)
        if: github.event_name != 'pull_request'
        run: |
          # TODO: implement full E2E when platform deployment is wired for CI
          echo "Skipping full E2E until manifests and steps are ready."
          pytest -q tests/bdd -k "not nothing" --maxfail=1 || true
      
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: reports/
      
      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: reports/*.xml
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { context, github } = require('@actions/github');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Smoke tests executed. JUnit XML uploaded as artifact: test-reports.'
            });
