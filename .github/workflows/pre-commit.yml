name: Pre-commit Validation

'on':
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  pre-commit:
    name: Run Pre-commit Hooks
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@34e11480ae1e31caa3f43c6f6043d4daa6e1148a  # v4.2.2
        with:
          fetch-depth: 0

      # ========================================================================
      # Setup Python for pre-commit
      # ========================================================================
      - name: Set up Python
        uses: actions/setup-python@a26af680b6b9b1949f9c02f9e0c6e9f0b2e3c5e4  # v5.3.0
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      # ========================================================================
      # Setup Terraform
      # ========================================================================
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd  # v3.1.2
        with:
          terraform_version: 1.9.5

      # Cache Terraform providers
      - name: Cache Terraform providers
        uses: actions/cache@0057852d52279ba093e21d2f6cbbf3c48fb752b7  # v4.2.0
        with:
          path: |
            ~/.terraform.d/plugin-cache
            **/.terraform/providers
          key: ${{ runner.os }}-terraform-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-terraform-

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@6e87008c3b5e1f9876c5af94e24ebf25e6991b8e  # v4.1.0
        with:
          tflint_version: latest

      # ========================================================================
      # Setup Kubernetes tools (optional for local hooks)
      # ========================================================================
      - name: Setup kubectl
        uses: azure/setup-kubectl@c0c8b327e82dc3bb5e3432d4ffbc9b0e7c88199e  # v4.0.0
        with:
          version: 'v1.28.0'

      - name: Setup Helm
        uses: azure/setup-helm@bf6a7d3e2e8b09c4ba0a0d79854aacf0a6f29f60  # v4.2.0
        with:
          version: 'v3.13.0'

      - name: Install kubeval
        run: |
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin
          rm kubeval-linux-amd64.tar.gz

      - name: Install kustomize
        run: |
          # Use direct binary download to avoid GitHub API rate limits
          VERSION="v5.3.0"
          wget -O kustomize.tar.gz "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2F${VERSION}/kustomize_${VERSION}_linux_amd64.tar.gz"
          tar -xzf kustomize.tar.gz
          sudo mv kustomize /usr/local/bin/
          rm kustomize.tar.gz
          kustomize version

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      # ========================================================================
      # Setup ArgoCD CLI (for GitOps validation)
      # ========================================================================
      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd-linux-amd64 \
            https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
          rm argocd-linux-amd64

      # ========================================================================
      # Install MkDocs for documentation validation
      # ========================================================================
      - name: Install MkDocs
        run: |
          pip install -r requirements.txt

      # ========================================================================
      # Run pre-commit hooks
      # ========================================================================
      - name: Cache pre-commit environments
        uses: actions/cache@0057852d52279ba093e21d2f6cbbf3c48fb752b7  # v4.2.0
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-

      - name: Run pre-commit on all files
        id: pre-commit
        run: |
          # Run pre-commit and capture output
          pre-commit run --all-files --show-diff-on-failure --color=always 2>&1 | tee pre-commit-output.txt
        continue-on-error: true

      - name: Check pre-commit status
        if: steps.pre-commit.outcome == 'failure'
        run: |
          echo "::warning::Pre-commit checks failed. Please review the output above and fix the issues."
          exit 1

      # ========================================================================
      # Upload pre-commit results as artifact
      # ========================================================================
      - name: Upload pre-commit results
        if: always()
        uses: actions/upload-artifact@ea165f8e4cf8965c7a8f4f88f034a7ca961c27d3  # v4.5.0
        with:
          name: pre-commit-results
          path: pre-commit-output.txt

      # ========================================================================
      # Comment on PR with results (optional)
      # ========================================================================
      - name: Comment PR with pre-commit results
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@f28e40c047f81b85d8c3c35c566b93bcf61b9cfd  # v7.0.1
        with:
          script: |
            const fs = require('fs');
            let output = '';
            try {
              output = fs.readFileSync('pre-commit-output.txt', 'utf8');
            } catch (error) {
              output = 'Could not read pre-commit output file.';
            }

            const maxLength = 60000; // GitHub comment size limit
            if (output.length > maxLength) {
              output = output.substring(0, maxLength) + '\n\n... (output truncated)';
            }

            const body = `## ⚠️ Pre-commit Validation Failed

            Some pre-commit hooks have failed. Please review and fix the issues below:

            <details>
            <summary>Pre-commit output</summary>

            \`\`\`
            ${output}
            \`\`\`

            </details>

            ### How to fix:
            1. Install pre-commit locally: \`make pre-commit-setup\`
            2. Run pre-commit: \`pre-commit run --all-files\`
            3. Fix the reported issues
            4. Commit and push your changes

            Or let pre-commit auto-fix issues:
            \`\`\`bash
            pre-commit run --all-files
            git add -u
            git commit -m "Fix pre-commit issues"
            git push
            \`\`\`
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ==========================================================================
  # GitOps Validation Job - Specific checks for ArgoCD and GitOps workflows
  # ==========================================================================
  gitops-validation:
    name: GitOps & ArgoCD Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@34e11480ae1e31caa3f43c6f6043d4daa6e1148a  # v4.2.2

      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd-linux-amd64 \
            https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
          rm argocd-linux-amd64

      - name: Validate ArgoCD Applications
        run: |
          echo "Validating ArgoCD application manifests..."
          find . -name "*-application.yaml" -o -name "application.yaml" | while read app; do
            echo "Validating $app"
            # Basic YAML validation
            python -c "import yaml; yaml.safe_load(open('$app'))" || exit 1
            # Check required fields
            if ! grep -q "kind: Application" "$app"; then
              echo "Error: $app is missing 'kind: Application'"
              exit 1
            fi
          done

      - name: Check for GitOps best practices
        run: |
          echo "Checking GitOps best practices..."
          # Check that manifests are organized properly
          if [ -d "infra/kubernetes" ]; then
            echo "✓ Kubernetes manifests directory exists"
          fi
          # Check for kustomization files
          if find infra/kubernetes -name "kustomization.yaml" | grep -q .; then
            echo "✓ Kustomization files found"
          else
            echo "⚠️  No kustomization files found - consider using Kustomize for GitOps"
          fi

  # ==========================================================================
  # IDP Validation Job - Backstage and platform components
  # ==========================================================================
  idp-validation:
    name: IDP Components Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@34e11480ae1e31caa3f43c6f6043d4daa6e1148a  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af680b6b9b1949f9c02f9e0c6e9f0b2e3c5e4  # v5.3.0
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Validate Backstage catalog files
        run: |
          echo "Validating Backstage catalog files..."
          find . -name "catalog-info.yaml" -o -name "*.catalog-info.yaml" | while read catalog; do
            echo "Validating $catalog"
            yq eval . "$catalog" > /dev/null || exit 1
            # Check for required Backstage fields
            if ! yq eval '.apiVersion' "$catalog" | grep -q "backstage.io"; then
              echo "⚠️  $catalog might not be a valid Backstage catalog (missing backstage.io apiVersion)"
            fi
          done

      - name: Validate Backstage Helm values
        if: hashFiles('infra/kubernetes/backstage/values.yaml') != ''
        run: |
          echo "Validating Backstage Helm values..."
          yq eval . infra/kubernetes/backstage/values.yaml > /dev/null

      - name: Install MkDocs deps
        run: |
          pip install -r requirements.txt

      - name: Build docs (non-strict for PRs and non-main pushes)
        if: github.event_name != 'push' || github.ref != 'refs/heads/main'
        run: |
          echo "Building MkDocs without strict mode (warnings won't fail CI)..."
          mkdocs build --verbose | tee mkdocs-build.txt
          if grep -q "WARNING -" mkdocs-build.txt; then
            echo "::warning::MkDocs produced warnings. See mkdocs-build.txt artifact."
          fi

      - name: Build docs (non-strict on main; warn only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "Building MkDocs without strict mode on main (warnings won't fail CI)..."
          mkdocs build --verbose | tee mkdocs-build.txt
          if grep -q "WARNING -" mkdocs-build.txt; then
            echo "::warning::MkDocs produced warnings on main. See mkdocs-build.txt artifact."
          fi

      - name: Upload MkDocs build log
        if: always() && hashFiles('mkdocs-build.txt') != ''
        uses: actions/upload-artifact@ea165f8e4cf8965c7a8f4f88f034a7ca961c27d3  # v4.5.0
        with:
          name: mkdocs-build-log
          path: mkdocs-build.txt

      - name: Check documentation links
        run: |
          echo "Checking for broken documentation links..."
          # This is a basic check - you might want to use a more sophisticated link checker
          if [ -d "docs" ]; then
            echo "✓ Documentation directory exists"
          fi
