# Stage Transition Rules Configuration
# Defines allowed transitions, validations, and automation for work item flow

# Allowed transitions between stages
# Format: from_stage -> to_stage with optional conditions
allowed_transitions:
  - from: Backlog
    to: Design
    description: Pull work item from backlog into design phase
    required_fields: []
    
  - from: Design
    to: Development
    description: Design approved, ready for implementation
    required_fields:
      - design_document
      - acceptance_criteria
    
  - from: Development
    to: Code Review
    description: Implementation complete, ready for review
    required_fields:
      - pull_request_url
      - unit_tests_passing
    
  - from: Code Review
    to: Development
    description: Review feedback requires changes
    required_fields:
      - review_comments
    
  - from: Code Review
    to: Testing
    description: Code review approved, ready for testing
    required_fields:
      - approval_count
    validation:
      min_approvals: 2
    
  - from: Testing
    to: Development
    description: Testing found defects, return to development
    required_fields:
      - defect_list
    
  - from: Testing
    to: Deployment Approval
    description: Testing passed, ready for deployment approval
    required_fields:
      - test_results_url
      - test_coverage_percent
    validation:
      min_test_coverage: 80
    
  - from: Deployment Approval
    to: Testing
    description: Deployment approval denied, return to testing
    required_fields:
      - rejection_reason
    
  - from: Deployment Approval
    to: Deploy
    description: Deployment approved by stakeholders
    required_fields:
      - approver_name
      - deployment_plan
    
  - from: Deploy
    to: Production
    description: Deployment successful, now in production
    required_fields:
      - deployment_timestamp
      - deployment_status
    validation:
      deployment_status: success
    
  - from: Deploy
    to: Deployment Approval
    description: Deployment failed, needs re-approval
    required_fields:
      - failure_reason
      - rollback_completed

# Automated transitions triggered by external events
automated_transitions:
  - name: auto_deploy_success
    description: Automatically move to Production when deployment succeeds
    trigger:
      event_type: deployment.completed
      event_status: success
    from: Deploy
    to: Production
    
  - name: auto_deploy_failure
    description: Automatically return to Deployment Approval on deployment failure
    trigger:
      event_type: deployment.completed
      event_status: failure
    from: Deploy
    to: Deployment Approval
    
  - name: auto_code_review_approved
    description: Automatically move to Testing when PR is approved
    trigger:
      event_type: pull_request.approved
      min_approvals: 2
      checks_passing: true
    from: Code Review
    to: Testing
    
  - name: auto_ci_failure
    description: Automatically return to Development when CI checks fail
    trigger:
      event_type: ci.failed
    from: Code Review
    to: Development

# Validation rules for transitions
validation_rules:
  - name: wip_limit_enforcement
    description: Enforce WIP limits when moving to a stage
    type: pre_transition
    check: wip_limit
    action: reject
    message: "Cannot transition: WIP limit exceeded for target stage"
    
  - name: required_fields_check
    description: Ensure all required fields are provided
    type: pre_transition
    check: required_fields
    action: reject
    message: "Cannot transition: Missing required fields"
    
  - name: approval_count_check
    description: Verify minimum approval count is met
    type: pre_transition
    check: min_approvals
    action: reject
    message: "Cannot transition: Minimum approvals not met"
    
  - name: test_coverage_check
    description: Ensure minimum test coverage is achieved
    type: pre_transition
    check: min_test_coverage
    action: warn
    message: "Warning: Test coverage below recommended threshold"

# Notifications triggered on stage transitions
notifications:
  - transition_to: Code Review
    notify:
      - type: slack
        channel: "#code-reviews"
        message: "New code review needed: {work_item_title}"
      - type: email
        recipients: code-review-team@example.com
        subject: "Code Review Required: {work_item_title}"
        
  - transition_to: Deployment Approval
    notify:
      - type: slack
        channel: "#release-management"
        message: "Deployment approval needed: {work_item_title}"
      - type: email
        recipients: release-managers@example.com
        subject: "Deployment Approval Required: {work_item_title}"
        
  - transition_to: Production
    notify:
      - type: slack
        channel: "#deployments"
        message: "âœ… Deployed to production: {work_item_title}"
      - type: metrics
        event: work_item.deployed
        labels:
          type: "{work_item_type}"
          stage: "production"

# Backward transition rules (for handling defects/issues)
backward_transitions:
  allowed: true
  max_backward_jumps: 2  # Limit how far back an item can move
  require_reason: true
  track_rework: true  # Track rework cycles for metrics

# Flow metrics configuration
metrics:
  cycle_time:
    start_stage: Design
    end_stage: Production
    exclude_wait_stages: false  # Include wait time in cycle time
    
  lead_time:
    start_stage: Backlog
    end_stage: Production
    
  flow_efficiency:
    active_stages:
      - Design
      - Development
      - Testing
      - Deploy
    wait_stages:
      - Backlog
      - Code Review
      - Deployment Approval
