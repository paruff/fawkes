# Copyright (c) 2025  Philip Ruff
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
# IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
# DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
# OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE
# OR OTHER DEALINGS IN THE SOFTWARE.

# ============================================================================
# FILE: services/nps/k8s/cronjob-quarterly.yaml
# PURPOSE: CronJob for quarterly NPS survey distribution
# SCHEDULE: First day of every quarter at 9 AM UTC (Jan 1, Apr 1, Jul 1, Oct 1)
# ============================================================================
apiVersion: batch/v1
kind: CronJob
metadata:
  name: nps-survey-quarterly
  namespace: fawkes
  labels:
    app: nps-service
    app.kubernetes.io/name: nps-service
    app.kubernetes.io/version: v1.0.0
    app.kubernetes.io/component: platform
    app.kubernetes.io/part-of: fawkes
    app.kubernetes.io/managed-by: argocd
    job-type: survey-distribution
spec:
  # Run on the first day of each quarter at 9 AM UTC
  # 0 9 1 */3 * = minute=0, hour=9, day=1, month=every 3 months
  schedule: "0 9 1 */3 *"

  # Keep last 3 successful and 1 failed job
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1

  # Don't allow concurrent runs
  concurrencyPolicy: Forbid

  jobTemplate:
    metadata:
      labels:
        app: nps-service
        app.kubernetes.io/name: nps-service
        app.kubernetes.io/version: v1.0.0
        app.kubernetes.io/component: platform
        app.kubernetes.io/part-of: fawkes
        job-type: survey-distribution
    spec:
      # Clean up completed job after 7 days
      ttlSecondsAfterFinished: 604800

      template:
        metadata:
          labels:
            app: nps-service
            app.kubernetes.io/name: nps-service
            app.kubernetes.io/version: v1.0.0
            app.kubernetes.io/component: platform
            app.kubernetes.io/part-of: fawkes
            job-type: survey-distribution
        spec:
          restartPolicy: OnFailure
          serviceAccountName: nps-service

          # Security context
          securityContext:
            runAsNonRoot: true
            runAsUser: 65534
            runAsGroup: 65534
            fsGroup: 65534

          containers:
            - name: survey-sender
              image: nps-service:latest
              imagePullPolicy: IfNotPresent

              # Override command to run survey distribution script
              command: ["python"]
              args: ["scripts/send-survey.py", "--all-users"]

              env:
                - name: DATABASE_URL
                  valueFrom:
                    secretKeyRef:
                      name: nps-service-secret
                      key: database_url
                - name: MATTERMOST_URL
                  valueFrom:
                    configMapKeyRef:
                      name: nps-service-config
                      key: mattermost_url
                - name: MATTERMOST_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: nps-service-secret
                      key: mattermost_token
                - name: MATTERMOST_BOT_USER_ID
                  valueFrom:
                    secretKeyRef:
                      name: nps-service-secret
                      key: mattermost_bot_user_id
                - name: BASE_SURVEY_URL
                  valueFrom:
                    configMapKeyRef:
                      name: nps-service-config
                      key: base_survey_url

              # Resource limits for job
              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  cpu: 200m
                  memory: 256Mi

              # Security context
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                runAsNonRoot: true
                runAsUser: 65534
                capabilities:
                  drop:
                    - ALL
                seccompProfile:
                  type: RuntimeDefault

              # Volume mounts for writable directories
              volumeMounts:
                - name: tmp
                  mountPath: /tmp

          volumes:
            - name: tmp
              emptyDir: {}
