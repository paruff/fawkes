# ============================================================================
# FILE: platform/policies/mandatory-security.yaml
# PURPOSE: Mandatory security policies enforcing Pod Security Standards
#          These policies run in ENFORCE mode and will DENY non-compliant
#          resources from being created.
# ============================================================================
---
# Policy: Require containers to run as non-root
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-run-as-non-root
  labels:
    app.kubernetes.io/part-of: fawkes
    app.kubernetes.io/component: security-policy
    policy.fawkes.idp/category: security
    policy.fawkes.idp/severity: high
  annotations:
    policies.kyverno.io/title: Require Run As Non-Root
    policies.kyverno.io/category: Pod Security Standards (Restricted)
    policies.kyverno.io/severity: high
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Containers must run as non-root users for security. This policy
      validates that the securityContext.runAsNonRoot is set to true
      for all containers.
spec:
  validationFailureAction: Enforce
  background: true
  rules:
    - name: run-as-non-root
      match:
        any:
          - resources:
              kinds:
                - Pod
              namespaceSelector:
                matchExpressions:
                  - key: kubernetes.io/metadata.name
                    operator: NotIn
                    values:
                      - kube-system
                      - kube-public
                      - kube-node-lease
                      - kyverno
                      - vault
      validate:
        message: >-
          Containers must run as non-root. Set spec.securityContext.runAsNonRoot
          to true or spec.containers[*].securityContext.runAsNonRoot to true.
        pattern:
          spec:
            =(securityContext):
              =(runAsNonRoot): true
            containers:
              - =(securityContext):
                  =(runAsNonRoot): true
---
# Policy: Disallow privileged containers
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-privileged-containers
  labels:
    app.kubernetes.io/part-of: fawkes
    app.kubernetes.io/component: security-policy
    policy.fawkes.idp/category: security
    policy.fawkes.idp/severity: critical
  annotations:
    policies.kyverno.io/title: Disallow Privileged Containers
    policies.kyverno.io/category: Pod Security Standards (Baseline)
    policies.kyverno.io/severity: high
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Privileged containers are not allowed as they have full access to
      the host. This policy ensures that the privileged flag is not set
      to true.
spec:
  validationFailureAction: Enforce
  background: true
  rules:
    - name: disallow-privileged
      match:
        any:
          - resources:
              kinds:
                - Pod
              namespaceSelector:
                matchExpressions:
                  - key: kubernetes.io/metadata.name
                    operator: NotIn
                    values:
                      - kube-system
                      - kube-public
                      - kube-node-lease
                      - kyverno
      validate:
        message: >-
          Privileged containers are not allowed. Remove or set
          spec.containers[*].securityContext.privileged to false.
        pattern:
          spec:
            containers:
              - =(securityContext):
                  =(privileged): false
            =(initContainers):
              - =(securityContext):
                  =(privileged): false
            =(ephemeralContainers):
              - =(securityContext):
                  =(privileged): false
---
# Policy: Restrict host namespaces
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: restrict-host-namespaces
  labels:
    app.kubernetes.io/part-of: fawkes
    app.kubernetes.io/component: security-policy
    policy.fawkes.idp/category: security
    policy.fawkes.idp/severity: high
  annotations:
    policies.kyverno.io/title: Restrict Host Namespaces
    policies.kyverno.io/category: Pod Security Standards (Baseline)
    policies.kyverno.io/severity: high
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Host namespaces (hostNetwork, hostPID, hostIPC) should not be allowed
      as they provide access to shared host resources.
spec:
  validationFailureAction: Enforce
  background: true
  rules:
    - name: host-namespaces
      match:
        any:
          - resources:
              kinds:
                - Pod
              namespaceSelector:
                matchExpressions:
                  - key: kubernetes.io/metadata.name
                    operator: NotIn
                    values:
                      - kube-system
                      - kube-public
                      - kube-node-lease
                      - kyverno
      validate:
        message: >-
          Sharing host namespaces is not allowed. Set spec.hostNetwork,
          spec.hostPID, and spec.hostIPC to false.
        pattern:
          spec:
            =(hostNetwork): false
            =(hostPID): false
            =(hostIPC): false
---
# Policy: Disallow host ports
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-host-ports
  labels:
    app.kubernetes.io/part-of: fawkes
    app.kubernetes.io/component: security-policy
    policy.fawkes.idp/category: security
    policy.fawkes.idp/severity: medium
  annotations:
    policies.kyverno.io/title: Disallow Host Ports
    policies.kyverno.io/category: Pod Security Standards (Baseline)
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Containers should not use host ports as they bypass network policies
      and can cause port conflicts.
spec:
  validationFailureAction: Enforce
  background: true
  rules:
    - name: host-ports
      match:
        any:
          - resources:
              kinds:
                - Pod
              namespaceSelector:
                matchExpressions:
                  - key: kubernetes.io/metadata.name
                    operator: NotIn
                    values:
                      - kube-system
                      - kube-public
                      - kube-node-lease
                      - kyverno
                      - ingress-nginx
      validate:
        message: >-
          Host ports are not allowed. Remove spec.containers[*].ports[*].hostPort.
        pattern:
          spec:
            containers:
              - =(ports):
                  - =(hostPort): 0
            =(initContainers):
              - =(ports):
                  - =(hostPort): 0
            =(ephemeralContainers):
              - =(ports):
                  - =(hostPort): 0
---
# Policy: Disallow capabilities beyond defaults
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-capabilities
  labels:
    app.kubernetes.io/part-of: fawkes
    app.kubernetes.io/component: security-policy
    policy.fawkes.idp/category: security
    policy.fawkes.idp/severity: high
  annotations:
    policies.kyverno.io/title: Disallow Capabilities
    policies.kyverno.io/category: Pod Security Standards (Restricted)
    policies.kyverno.io/severity: high
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Adding capabilities beyond the default set is not allowed.
      Capabilities should be dropped, not added.
spec:
  validationFailureAction: Enforce
  background: true
  rules:
    - name: require-drop-all
      match:
        any:
          - resources:
              kinds:
                - Pod
              namespaceSelector:
                matchExpressions:
                  - key: kubernetes.io/metadata.name
                    operator: NotIn
                    values:
                      - kube-system
                      - kube-public
                      - kube-node-lease
                      - kyverno
      validate:
        message: >-
          Containers must drop all capabilities. Set
          spec.containers[*].securityContext.capabilities.drop to ["ALL"].
        pattern:
          spec:
            containers:
              - securityContext:
                  capabilities:
                    drop:
                      - ALL
---
# Policy: Require seccomp profile
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-seccomp-profile
  labels:
    app.kubernetes.io/part-of: fawkes
    app.kubernetes.io/component: security-policy
    policy.fawkes.idp/category: security
    policy.fawkes.idp/severity: medium
  annotations:
    policies.kyverno.io/title: Require Seccomp Profile
    policies.kyverno.io/category: Pod Security Standards (Restricted)
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Pods must use a seccomp profile for additional syscall filtering.
      RuntimeDefault or Localhost profiles are allowed.
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: check-seccomp
      match:
        any:
          - resources:
              kinds:
                - Pod
              namespaceSelector:
                matchExpressions:
                  - key: kubernetes.io/metadata.name
                    operator: NotIn
                    values:
                      - kube-system
                      - kube-public
                      - kube-node-lease
                      - kyverno
      validate:
        message: >-
          Pods should use a seccomp profile. Set
          spec.securityContext.seccompProfile.type to RuntimeDefault or Localhost.
        anyPattern:
          - spec:
              securityContext:
                seccompProfile:
                  type: RuntimeDefault
          - spec:
              securityContext:
                seccompProfile:
                  type: Localhost
          - spec:
              containers:
                - securityContext:
                    seccompProfile:
                      type: RuntimeDefault
          - spec:
              containers:
                - securityContext:
                    seccompProfile:
                      type: Localhost
