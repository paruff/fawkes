# Copyright (c) 2025  Philip Ruff
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
# IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
# DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
# OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE
# OR OTHER DEALINGS IN THE SOFTWARE.

# ============================================================================
# FILE: platform/apps/vault-csi-driver/secretproviderclass.yaml
# PURPOSE: SecretProviderClass configurations for mounting Vault secrets via CSI
#          Provides examples for common secret patterns.
# ============================================================================
---
# SecretProviderClass for database credentials
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: vault-database-creds
  namespace: fawkes
  labels:
    app: vault-csi
    component: secret-provider
spec:
  provider: vault
  parameters:
    # Vault server address
    vaultAddress: "http://vault.vault.svc:8200"
    # Vault role for Kubernetes auth
    roleName: "platform-service"
    # Secrets to fetch from Vault
    objects: |
      - objectName: "db-username"
        secretPath: "secret/data/fawkes/databases/default"
        secretKey: "username"
      - objectName: "db-password"
        secretPath: "secret/data/fawkes/databases/default"
        secretKey: "password"
      - objectName: "db-host"
        secretPath: "secret/data/fawkes/databases/default"
        secretKey: "host"
      - objectName: "db-port"
        secretPath: "secret/data/fawkes/databases/default"
        secretKey: "port"
  # Optionally sync to a Kubernetes Secret
  secretObjects:
    - secretName: database-credentials
      type: Opaque
      data:
        - objectName: db-username
          key: username
        - objectName: db-password
          key: password
        - objectName: db-host
          key: host
        - objectName: db-port
          key: port
---
# SecretProviderClass for Jenkins CI/CD secrets
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: vault-jenkins-secrets
  namespace: jenkins
  labels:
    app: vault-csi
    component: secret-provider
spec:
  provider: vault
  parameters:
    vaultAddress: "http://vault.vault.svc:8200"
    roleName: "jenkins"
    objects: |
      - objectName: "github-token"
        secretPath: "secret/data/fawkes/cicd/jenkins"
        secretKey: "github_token"
      - objectName: "docker-username"
        secretPath: "secret/data/fawkes/cicd/jenkins"
        secretKey: "docker_username"
      - objectName: "docker-password"
        secretPath: "secret/data/fawkes/cicd/jenkins"
        secretKey: "docker_password"
      - objectName: "admin-password"
        secretPath: "secret/data/fawkes/cicd/jenkins"
        secretKey: "admin_password"
  secretObjects:
    - secretName: jenkins-vault-secrets
      type: Opaque
      data:
        - objectName: github-token
          key: github-token
        - objectName: docker-username
          key: docker-username
        - objectName: docker-password
          key: docker-password
        - objectName: admin-password
          key: admin-password
---
# SecretProviderClass for Backstage portal secrets
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: vault-backstage-secrets
  namespace: fawkes
  labels:
    app: vault-csi
    component: secret-provider
spec:
  provider: vault
  parameters:
    vaultAddress: "http://vault.vault.svc:8200"
    roleName: "backstage"
    objects: |
      - objectName: "github-token"
        secretPath: "secret/data/fawkes/core/backstage"
        secretKey: "github_token"
      - objectName: "postgres-password"
        secretPath: "secret/data/fawkes/core/backstage"
        secretKey: "postgres_password"
      - objectName: "oauth-client-id"
        secretPath: "secret/data/fawkes/core/backstage"
        secretKey: "oauth_client_id"
      - objectName: "oauth-client-secret"
        secretPath: "secret/data/fawkes/core/backstage"
        secretKey: "oauth_client_secret"
  secretObjects:
    - secretName: backstage-vault-secrets
      type: Opaque
      data:
        - objectName: github-token
          key: github-token
        - objectName: postgres-password
          key: postgres-password
        - objectName: oauth-client-id
          key: oauth-client-id
        - objectName: oauth-client-secret
          key: oauth-client-secret
---
# SecretProviderClass for Grafana observability secrets
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: vault-grafana-secrets
  namespace: fawkes
  labels:
    app: vault-csi
    component: secret-provider
spec:
  provider: vault
  parameters:
    vaultAddress: "http://vault.vault.svc:8200"
    roleName: "grafana"
    objects: |
      - objectName: "admin-password"
        secretPath: "secret/data/fawkes/observability/grafana"
        secretKey: "admin_password"
      - objectName: "oauth-client-secret"
        secretPath: "secret/data/fawkes/observability/grafana"
        secretKey: "oauth_client_secret"
  secretObjects:
    - secretName: grafana-vault-secrets
      type: Opaque
      data:
        - objectName: admin-password
          key: admin-password
        - objectName: oauth-client-secret
          key: oauth-client-secret
---
# SecretProviderClass for shared platform secrets
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: vault-shared-secrets
  namespace: fawkes
  labels:
    app: vault-csi
    component: secret-provider
spec:
  provider: vault
  parameters:
    vaultAddress: "http://vault.vault.svc:8200"
    roleName: "platform-service"
    objects: |
      - objectName: "github-token"
        secretPath: "secret/data/fawkes/shared/github"
        secretKey: "token"
      - objectName: "docker-config"
        secretPath: "secret/data/fawkes/shared/docker-registry"
        secretKey: "config_json"
  secretObjects:
    - secretName: shared-platform-secrets
      type: Opaque
      data:
        - objectName: github-token
          key: github-token
    - secretName: docker-registry-credentials
      type: kubernetes.io/dockerconfigjson
      data:
        - objectName: docker-config
          key: .dockerconfigjson
