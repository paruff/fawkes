# Copyright (c) 2025  Philip Ruff
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
# IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
# DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
# OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE
# OR OTHER DEALINGS IN THE SOFTWARE.

# ============================================================================
# FILE: platform/apps/focalboard/configmap.yaml
# PURPOSE: Configuration template for Focalboard server
#          NOTE: This is a TEMPLATE. The $(POSTGRES_PASSWORD) placeholder is
#          replaced at runtime by the init container using the actual password
#          from the db-focalboard-credentials Kubernetes Secret.
# ============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: focalboard-config
  namespace: fawkes
  labels:
    app: focalboard
    component: project-management
    environment: dev
    team: platform
data:
  # Focalboard configuration file template (JSON format)
  # The init container processes this template and replaces $(POSTGRES_PASSWORD)
  # with the actual secret value before the main container starts.
  config.json: |
    {
      "serverRoot": "http://pm.127.0.0.1.nip.io",
      "port": 8000,
      "dbtype": "postgres",
      "dbconfig": "postgres://focalboard_user:$(POSTGRES_PASSWORD)@db-focalboard-dev-rw.fawkes.svc.cluster.local:5432/focalboard?sslmode=require",
      "useSSL": false,
      "webpath": "./pack",
      "filespath": "./files",
      "telemetry": false,
      "prometheus_address": ":9092",
      "session_expire_time": 2592000,
      "session_refresh_time": 18000,
      "localOnly": false,
      "enableLocalMode": false,
      "localModeSocketLocation": "/var/tmp/focalboard_local.socket",
      "authMode": "native",
      "logging_cfg_file": "",
      "logging_cfg_json": "{\"def\": {\"type\": \"console\", \"options\": {\"out\": \"stdout\"}, \"format\": \"plain\", \"format_options\": {\"delim\": \" \", \"min_level_len\": 5, \"min_msg_len\": 40, \"enable_color\": true, \"enable_caller\": true}, \"levels\": [{\"id\": 5, \"name\": \"debug\", \"color\": 36}, {\"id\": 4, \"name\": \"info\", \"color\": 32}, {\"id\": 3, \"name\": \"warn\", \"color\": 33}, {\"id\": 2, \"name\": \"error\", \"color\": 31, \"stacktrace\": true}, {\"id\": 1, \"name\": \"fatal\", \"color\": 31, \"stacktrace\": true}]}, \"outputs\": [{\"name\": \"default\", \"type\": \"def\", \"levels\": [4, 3, 2, 1]}]}",
      "audit_cfg_file": "",
      "audit_cfg_json": ""
    }
