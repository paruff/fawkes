# Copyright (c) 2025  Philip Ruff
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
# IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
# DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
# OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE
# OR OTHER DEALINGS IN THE SOFTWARE.

# ============================================================================
# FILE: platform/apps/tempo/tempo-application.yaml
# PURPOSE: ArgoCD Application for Grafana Tempo deployment as distributed tracing backend
#          Stores and queries distributed traces from applications and platform services
# FEATURES:
#   - OTLP trace ingestion via gRPC and HTTP
#   - TraceQL query language for trace analysis
#   - Trace-to-logs and trace-to-metrics correlation
#   - Service dependency graph visualization
#   - Retention and sampling configuration
# SEE: docs/adr/ADR-013 distributed tracing.md
# ============================================================================
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: tempo
  namespace: fawkes
  labels:
    app: tempo
    component: observability
    environment: dev
    team: platform
  annotations:
    argocd.argoproj.io/sync-wave: "-2"
spec:
  project: default

  source:
    repoURL: https://grafana.github.io/helm-charts
    chart: tempo
    targetRevision: "1.10.3"
    helm:
      values: |
        # ============================================================
        # Tempo Server Configuration
        # ============================================================
        tempo:
          # ============================================================
          # Receivers Configuration - OTLP for trace ingestion
          # ============================================================
          receivers:
            otlp:
              protocols:
                grpc:
                  endpoint: 0.0.0.0:4317
                http:
                  endpoint: 0.0.0.0:4318

          # ============================================================
          # Storage Configuration - Local filesystem for development
          # For production, configure S3/MinIO backend
          # ============================================================
          storage:
            trace:
              backend: local
              local:
                path: /var/tempo/traces
              wal:
                path: /var/tempo/wal

          # ============================================================
          # Retention Configuration - 7 days for development
          # ============================================================
          retention: 168h  # 7 days

          # ============================================================
          # Metrics Generator - Generate RED metrics from traces
          # ============================================================
          metricsGenerator:
            enabled: true
            remoteWriteUrl: "http://prometheus-prometheus.monitoring.svc.cluster.local:9090/api/v1/write"
            processors:
              - service-graphs
              - span-metrics

          # ============================================================
          # Global Overrides
          # ============================================================
          global_overrides:
            per_tenant_override_config: /conf/overrides.yaml
            metrics_generator_processors:
              - service-graphs
              - span-metrics

        # ============================================================
        # Resource Configuration
        # ============================================================
        resources:
          requests:
            cpu: 200m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 2Gi

        # ============================================================
        # Persistence Configuration
        # ============================================================
        persistence:
          enabled: true
          size: 50Gi
          storageClassName: ""

        # ============================================================
        # Service Configuration
        # ============================================================
        service:
          type: ClusterIP

        # ============================================================
        # Service Account
        # ============================================================
        serviceAccount:
          create: true
          name: tempo

        # ============================================================
        # Pod Security Context
        # ============================================================
        securityContext:
          runAsNonRoot: true
          runAsUser: 10001
          runAsGroup: 10001
          fsGroup: 10001

        # ============================================================
        # Container Security Context
        # ============================================================
        containerSecurityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - ALL

        # ============================================================
        # Tempo Configuration Override
        # ============================================================
        config: |
          multitenancy_enabled: false
          usage_report:
            reporting_enabled: false
          compactor:
            compaction:
              block_retention: 168h
          distributor:
            receivers:
              otlp:
                protocols:
                  grpc:
                    endpoint: 0.0.0.0:4317
                  http:
                    endpoint: 0.0.0.0:4318
          ingester:
            trace_idle_period: 10s
            max_block_bytes: 1000000
            max_block_duration: 5m
          querier:
            frontend_worker:
              frontend_address: ""
          query_frontend:
            search:
              duration_slo: 5s
              throughput_bytes_slo: 1073741824
            trace_by_id:
              duration_slo: 5s
          server:
            http_listen_port: 3200
            grpc_listen_port: 9095
          storage:
            trace:
              backend: local
              local:
                path: /var/tempo/traces
              wal:
                path: /var/tempo/wal
              pool:
                max_workers: 100
                queue_depth: 10000
          metrics_generator:
            registry:
              external_labels:
                source: tempo
                cluster: fawkes-dev
            storage:
              path: /var/tempo/generator/wal
              remote_write:
                - url: http://prometheus-prometheus.monitoring.svc.cluster.local:9090/api/v1/write
                  send_exemplars: true
            processor:
              service_graphs:
                wait: 10s
                max_items: 10000
              span_metrics:
                dimensions:
                  - service.name
                  - http.method
                  - http.status_code
                  - http.route

        # ============================================================
        # Overrides Configuration
        # ============================================================
        overrides: |
          overrides: {}

  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - PrunePropagationPolicy=foreground
      - PruneLast=true
      - ServerSideApply=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

  ignoreDifferences:
    - group: apps
      kind: StatefulSet
      jsonPointers:
        - /spec/template/metadata/annotations

  revisionHistoryLimit: 10
