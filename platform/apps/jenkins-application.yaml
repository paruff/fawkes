# ============================================================================
# FILE: platform/apps/jenkins-application.yaml
# PURPOSE: ArgoCD Application definition for Jenkins CI/CD service
# USAGE: Applied automatically when ArgoCD discovers this manifest
# ACCESS:
#   Local: kubectl port-forward -n fawkes svc/jenkins 8080:8080
#          Then browse to http://localhost:8080
#   Cloud: Access via ingress at jenkins.<your-domain> or through LoadBalancer
# ============================================================================
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: jenkins
  namespace: fawkes
  labels:
    app.kubernetes.io/name: jenkins
    app.kubernetes.io/component: ci-cd
    app.kubernetes.io/part-of: fawkes-platform
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  project: default

  source:
    # Official Jenkins Helm repo
    repoURL: https://charts.jenkins.io
    chart: jenkins
    targetRevision: "5.8.3"  # Use stable version
    helm:
      # Values for Jenkins Helm chart - works for both local and cloud
      values: |
        controller:
          image:
            registry: docker.io
            repository: jenkins/jenkins
            tag: 2.479.1-lts-jdk21
            pullPolicy: IfNotPresent
          # Service type - ClusterIP works with both port-forward (local) and Ingress (cloud)
          serviceType: ClusterIP
          # Don't run builds on controller - use agents
          executors: 0
          # Admin credentials for local development
          # In production, use External Secrets Operator to inject credentials
          admin:
            username: admin
            password: fawkesidp
          # Java options for Jenkins
          javaOpts: "-Djenkins.install.runSetupWizard=false"
          # Jenkins Configuration as Code
          JCasC:
            enabled: true
            defaultConfig: true
            configScripts:
              welcome-message: |
                jenkins:
                  systemMessage: "Fawkes CI/CD Platform - Managed by ArgoCD"
          # Install essential plugins (under controller per Helm chart spec)
          installPlugins:
            - kubernetes:4371.vb_33b_086d54a_1
            - workflow-aggregator:608.v67378e9d3db_1
            - git:5.7.0
            - configuration-as-code:1985.vdda_32d0c4ea_b_
            - credentials-binding:681.vf91669a_32e45
            - github:1.43.0
          # Additional plugins for CI/CD workflows
          additionalPlugins:
            - blueocean:1.27.16
            - pipeline-stage-view:2.34
          # Ingress configuration - enabled for cloud access
          # For local development, use port-forward instead
          ingress:
            enabled: true
            ingressClassName: nginx
            hostName: jenkins.127.0.0.1.nip.io
            annotations:
              nginx.ingress.kubernetes.io/proxy-body-size: "50m"
              nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
            paths:
              - path: /
                pathType: Prefix
          # Resource limits suitable for development
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 4Gi
        # Agent configuration for Kubernetes-based builds
        agent:
          enabled: true
          namespace: fawkes
          image:
            repository: jenkins/inbound-agent
            tag: "3307.vb_cb_6f6a_b_5adb-1"
          resources:
            requests:
              cpu: 512m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1Gi
        # Persistence - disabled for local, enable for production
        persistence:
          enabled: false
          # Uncomment and configure for production:
          # enabled: true
          # size: 20Gi
          # storageClass: ""  # Use cluster default
        serviceAccount:
          create: true
          name: jenkins
        rbac:
          create: true

  destination:
    server: https://kubernetes.default.svc
    namespace: fawkes

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - PrunePropagationPolicy=foreground
      - PruneLast=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

  ignoreDifferences:
    - group: apps
      kind: Deployment
      jsonPointers:
        - /spec/replicas
    - group: ""
      kind: Secret
      jsonPointers:
        - /data

  revisionHistoryLimit: 10
