# Copyright (c) 2025  Philip Ruff
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
# IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
# DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
# OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE
# OR OTHER DEALINGS IN THE SOFTWARE.

# ============================================================================
# FILE: platform/apps/opentelemetry/otel-collector-application.yaml
# PURPOSE: ArgoCD Application for OpenTelemetry Collector deployment as DaemonSet
#          Collects and exports metrics and logs from applications and infrastructure
# FEATURES:
#   - Log collection from container stdout/stderr via filelog receiver
#   - Kubernetes context enrichment (k8s.pod.name, k8s.namespace.name, k8s.container.name)
#   - Trace correlation (traceId, spanId) preserved for log-trace correlation
#   - OTLP export to OpenSearch for centralized log storage
#   - Failure handling with memory_limiter and batch processor (5+ min buffer)
# SEE: docs/adr/ADR-011 Centralized Log Management.md
# ============================================================================
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: otel-collector
  namespace: fawkes
  labels:
    app: otel-collector
    component: observability
    environment: dev
    team: platform
  annotations:
    argocd.argoproj.io/sync-wave: "-2"
spec:
  project: default

  source:
    repoURL: https://open-telemetry.github.io/opentelemetry-helm-charts
    chart: opentelemetry-collector
    targetRevision: "0.108.0"
    helm:
      values: |
        # ============================================================
        # Deployment Mode: DaemonSet for node-level log and metric collection
        # ============================================================
        mode: daemonset

        # ============================================================
        # Image Configuration
        # ============================================================
        image:
          repository: otel/opentelemetry-collector-contrib
          tag: "0.114.0"

        # ============================================================
        # Resource Configuration
        # Increased memory for log buffering (5+ min retention)
        # ============================================================
        resources:
          requests:
            cpu: 200m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 1Gi

        # ============================================================
        # Service Account
        # ============================================================
        serviceAccount:
          create: true
          name: otel-collector

        # ============================================================
        # Cluster Role for Kubernetes metrics
        # ============================================================
        clusterRole:
          create: true
          rules:
            - apiGroups: [""]
              resources:
                - nodes
                - nodes/proxy
                - nodes/metrics
                - services
                - endpoints
                - pods
                - namespaces
              verbs: ["get", "list", "watch"]
            - apiGroups: [""]
              resources:
                - configmaps
              verbs: ["get"]
            - apiGroups: ["apps"]
              resources:
                - daemonsets
                - deployments
                - replicasets
                - statefulsets
              verbs: ["get", "list", "watch"]
            - nonResourceURLs: ["/metrics", "/metrics/cadvisor"]
              verbs: ["get"]

        # ============================================================
        # Pod Security Context
        # Note: filelog receiver needs access to /var/log, running as
        # non-root with fsGroup for log file access
        # ============================================================
        podSecurityContext:
          runAsNonRoot: true
          runAsUser: 10001
          runAsGroup: 10001
          fsGroup: 10001

        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          capabilities:
            drop:
              - ALL

        # ============================================================
        # OpenTelemetry Collector Configuration
        # ============================================================
        config:
          receivers:
            # OTLP receiver for applications sending metrics and logs via OpenTelemetry SDK
            otlp:
              protocols:
                grpc:
                  endpoint: 0.0.0.0:4317
                http:
                  endpoint: 0.0.0.0:4318

            # ============================================================
            # Filelog Receiver for Container Log Collection
            # Collects logs from /var/log/containers/*.log
            # Parses Kubernetes container log format (CRI/Docker)
            # ============================================================
            filelog:
              include:
                - /var/log/containers/*.log
              exclude:
                # Exclude collector's own logs to avoid feedback loops
                - /var/log/containers/*otel-collector*.log
              start_at: end
              include_file_path: true
              include_file_name: false
              # Parse container runtime log format
              operators:
                # Extract metadata from file path
                - type: regex_parser
                  id: container_parser
                  regex: '^/var/log/containers/(?P<pod_name>[^_]+)_(?P<namespace>[^_]+)_(?P<container_name>[^-]+)-(?P<container_id>[a-f0-9]{64})\.log$$'
                  parse_from: attributes["log.file.path"]
                  parse_to: attributes
                # Parse JSON log body for CRI format
                - type: json_parser
                  id: json_parser
                  parse_from: body
                  parse_to: attributes
                  timestamp:
                    parse_from: attributes.time
                    layout: '%Y-%m-%dT%H:%M:%S.%LZ'
                # Move log content to body
                - type: move
                  from: attributes.log
                  to: body
                # Extract log level if present in structured logs
                - type: severity_parser
                  parse_from: attributes.level
                  if: attributes.level != nil
                  preset: none
                  mapping:
                    fatal: fatal
                    error: error
                    warn: warn
                    warning: warn
                    info: info
                    debug: debug
                    trace: trace
                # Extract traceId and spanId from structured logs (W3C traceparent)
                - type: regex_parser
                  id: trace_parser
                  regex: '"traceId"\s*:\s*"(?P<trace_id>[a-f0-9]{32})".*"spanId"\s*:\s*"(?P<span_id>[a-f0-9]{16})"'
                  parse_from: body
                  parse_to: attributes
                  if: body matches '"traceId"'

            # Prometheus receiver for scraping /metrics endpoints
            prometheus:
              config:
                scrape_configs:
                  # Scrape applications with prometheus.io annotations
                  - job_name: 'kubernetes-pods'
                    kubernetes_sd_configs:
                      - role: pod
                    relabel_configs:
                      # Only scrape pods with prometheus.io/scrape=true
                      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
                        action: keep
                        regex: true
                      # Use custom port if specified
                      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
                        action: replace
                        regex: ([^:]+)(?::\d+)?;(\d+)
                        target_label: __address__
                        replacement: $$1:$$2
                      # Use custom path if specified
                      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
                        action: replace
                        target_label: __metrics_path__
                        regex: (.+)
                      # Add Kubernetes labels
                      - source_labels: [__meta_kubernetes_namespace]
                        action: replace
                        target_label: namespace
                      - source_labels: [__meta_kubernetes_pod_name]
                        action: replace
                        target_label: pod_name
                      - source_labels: [__meta_kubernetes_pod_label_app]
                        action: replace
                        target_label: app
                      - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
                        action: replace
                        target_label: service_name

            # Kubelet metrics receiver for container-level metrics
            kubeletstats:
              collection_interval: 30s
              auth_type: "serviceAccount"
              endpoint: "https://$${NODE_IP}:10250"
              insecure_skip_verify: true
              metric_groups:
                - container
                - pod
                - node

            # Host metrics receiver for node-level metrics
            hostmetrics:
              collection_interval: 30s
              scrapers:
                cpu:
                  metrics:
                    system.cpu.utilization:
                      enabled: true
                disk: {}
                filesystem: {}
                load: {}
                memory:
                  metrics:
                    system.memory.utilization:
                      enabled: true
                network: {}

          processors:
            # ============================================================
            # Batch Processor for Efficient Exporting
            # Configured for 5+ minute buffer retention on failure
            # ============================================================
            batch:
              timeout: 10s
              send_batch_size: 1000
              send_batch_max_size: 2000

            # Separate batch config for logs with larger buffer
            batch/logs:
              timeout: 5s
              send_batch_size: 500
              send_batch_max_size: 1000

            # ============================================================
            # Memory Limiter to Prevent OOM
            # Configured to buffer logs during backend unavailability
            # 5+ minute retention: ~800MiB allows substantial buffering
            # ============================================================
            memory_limiter:
              check_interval: 5s
              limit_mib: 800
              spike_limit_mib: 200

            # ============================================================
            # Resource Detection for Kubernetes Attributes
            # ============================================================
            resourcedetection:
              detectors:
                - env
                - system
              system:
                hostname_sources:
                  - os
              timeout: 5s
              override: false

            # ============================================================
            # K8s Attributes Processor for Kubernetes Context Enrichment
            # Adds mandatory attributes: k8s.pod.name, k8s.namespace.name,
            # k8s.container.name, k8s.deployment.name per ADR-011
            # ============================================================
            k8sattributes:
              auth_type: "serviceAccount"
              passthrough: false
              filter:
                node_from_env_var: K8S_NODE_NAME
              extract:
                metadata:
                  - k8s.namespace.name
                  - k8s.pod.name
                  - k8s.pod.uid
                  - k8s.deployment.name
                  - k8s.statefulset.name
                  - k8s.daemonset.name
                  - k8s.replicaset.name
                  - k8s.node.name
                  - k8s.container.name
                  - container.id
                  - container.image.name
                  - container.image.tag
                labels:
                  - tag_name: app
                    key: app
                    from: pod
                  - tag_name: service_name
                    key: app.kubernetes.io/name
                    from: pod
                  - tag_name: component
                    key: app.kubernetes.io/component
                    from: pod
                  - tag_name: version
                    key: app.kubernetes.io/version
                    from: pod
              pod_association:
                - sources:
                    - from: resource_attribute
                      name: k8s.pod.ip
                - sources:
                    - from: resource_attribute
                      name: k8s.pod.uid
                - sources:
                    - from: resource_attribute
                      name: k8s.pod.name
                    - from: resource_attribute
                      name: k8s.namespace.name

            # ============================================================
            # Transform Processor for Resource Labels
            # ============================================================
            transform:
              metric_statements:
                - context: resource
                  statements:
                    - set(attributes["cluster"], "fawkes-dev")
                    - set(attributes["environment"], "development")

            # Transform processor for logs - add cluster context
            transform/logs:
              log_statements:
                - context: resource
                  statements:
                    - set(attributes["cluster"], "fawkes-dev")
                    - set(attributes["environment"], "development")
                - context: log
                  statements:
                    # Move trace context to resource attributes for correlation
                    - set(resource.attributes["trace_id"], attributes["trace_id"]) where attributes["trace_id"] != nil
                    - set(resource.attributes["span_id"], attributes["span_id"]) where attributes["span_id"] != nil

            # ============================================================
            # Attributes Processor for Log Enrichment
            # Maps filelog-extracted attributes to semantic conventions
            # ============================================================
            attributes/logs:
              actions:
                - key: k8s.pod.name
                  from_attribute: pod_name
                  action: upsert
                - key: k8s.namespace.name
                  from_attribute: namespace
                  action: upsert
                - key: k8s.container.name
                  from_attribute: container_name
                  action: upsert
                - key: container.id
                  from_attribute: container_id
                  action: upsert

          exporters:
            # ============================================================
            # Prometheus Remote Write Exporter (Metrics)
            # ============================================================
            prometheusremotewrite:
              endpoint: "http://prometheus-prometheus.monitoring.svc.cluster.local:9090/api/v1/write"
              tls:
                insecure: true
              resource_to_telemetry_conversion:
                enabled: true

            # ============================================================
            # OTLP/HTTP Exporter for OpenSearch (Logs)
            # Sends logs via OTLP to OpenSearch Data Prepper or
            # OpenSearch with OTLP ingestion plugin
            # Configured with retry and queue for failure handling
            # ============================================================
            otlphttp/opensearch:
              endpoint: "http://opensearch-cluster-master.logging.svc.cluster.local:9200"
              tls:
                insecure: true
              # Retry configuration for transient failures
              retry_on_failure:
                enabled: true
                initial_interval: 5s
                max_interval: 30s
                max_elapsed_time: 300s
              # Queue configuration for 5+ minute buffering
              sending_queue:
                enabled: true
                num_consumers: 10
                queue_size: 5000

            # ============================================================
            # Debug Exporter for Troubleshooting (disabled in production)
            # ============================================================
            debug:
              verbosity: basic
              sampling_initial: 5
              sampling_thereafter: 200

          extensions:
            health_check:
              endpoint: 0.0.0.0:13133
            zpages:
              endpoint: 0.0.0.0:55679
            # File storage extension for persistent queue during restarts
            file_storage:
              directory: /var/lib/otelcol/file_storage
              timeout: 10s

          service:
            extensions:
              - health_check
              - zpages
              - file_storage
            pipelines:
              # ============================================================
              # Metrics Pipeline
              # ============================================================
              metrics:
                receivers:
                  - otlp
                  - prometheus
                  - kubeletstats
                  - hostmetrics
                processors:
                  - memory_limiter
                  - k8sattributes
                  - resourcedetection
                  - transform
                  - batch
                exporters:
                  - prometheusremotewrite

              # ============================================================
              # Logs Pipeline
              # Collects logs from containers and OTLP, enriches with
              # Kubernetes context, and exports to OpenSearch
              # ============================================================
              logs:
                receivers:
                  - filelog
                  - otlp
                processors:
                  - memory_limiter
                  - attributes/logs
                  - k8sattributes
                  - resourcedetection
                  - transform/logs
                  - batch/logs
                exporters:
                  - otlphttp/opensearch

        # ============================================================
        # Ports Configuration
        # ============================================================
        ports:
          otlp:
            enabled: true
            containerPort: 4317
            servicePort: 4317
            protocol: TCP
          otlp-http:
            enabled: true
            containerPort: 4318
            servicePort: 4318
            protocol: TCP
          metrics:
            enabled: true
            containerPort: 8888
            servicePort: 8888
            protocol: TCP
          health:
            enabled: true
            containerPort: 13133
            servicePort: 13133
            protocol: TCP
          zpages:
            enabled: true
            containerPort: 55679
            servicePort: 55679
            protocol: TCP

        # ============================================================
        # Environment Variables
        # ============================================================
        extraEnvs:
          - name: K8S_NODE_NAME
            valueFrom:
              fieldRef:
                fieldPath: spec.nodeName
          - name: NODE_IP
            valueFrom:
              fieldRef:
                fieldPath: status.hostIP

        # ============================================================
        # Tolerations for running on all nodes
        # ============================================================
        tolerations:
          - key: node-role.kubernetes.io/master
            operator: Exists
            effect: NoSchedule
          - key: node-role.kubernetes.io/control-plane
            operator: Exists
            effect: NoSchedule

        # ============================================================
        # Pod Monitoring for self-metrics
        # ============================================================
        podMonitor:
          enabled: true
          metricsEndpoints:
            - port: metrics
              interval: 30s

        # ============================================================
        # Volume Mounts for Log Collection and File Storage
        # Required for filelog receiver and persistent queue
        # ============================================================
        extraVolumes:
          - name: varlogcontainers
            hostPath:
              path: /var/log/containers
          - name: varlogpods
            hostPath:
              path: /var/log/pods
          - name: varlibdockercontainers
            hostPath:
              path: /var/lib/docker/containers
          - name: file-storage
            emptyDir:
              sizeLimit: 500Mi

        extraVolumeMounts:
          - name: varlogcontainers
            mountPath: /var/log/containers
            readOnly: true
          - name: varlogpods
            mountPath: /var/log/pods
            readOnly: true
          - name: varlibdockercontainers
            mountPath: /var/lib/docker/containers
            readOnly: true
          - name: file-storage
            mountPath: /var/lib/otelcol/file_storage

  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - PrunePropagationPolicy=foreground
      - PruneLast=true
      - ServerSideApply=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

  ignoreDifferences:
    - group: apps
      kind: DaemonSet
      jsonPointers:
        - /spec/template/metadata/annotations

  revisionHistoryLimit: 10
