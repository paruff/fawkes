# ============================================================================
# FILE: platform/apps/weaviate-application.yaml
# PURPOSE: ArgoCD Application for Weaviate vector database deployment
#          Provides vector search engine for RAG (Retrieval Augmented Generation)
# PREREQ: fawkes namespace must exist
# ============================================================================
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: weaviate
  namespace: fawkes
  labels:
    app: weaviate
    component: vector-database
    environment: dev
    team: platform
  annotations:
    # Link to documentation
    argocd.argoproj.io/docs: "https://weaviate.io/developers/weaviate"
    # Sync wave to ensure namespace exists first
    argocd.argoproj.io/sync-wave: "10"
spec:
  project: default

  source:
    repoURL: https://weaviate.github.io/weaviate-helm
    chart: weaviate
    targetRevision: "16.8.8"
    helm:
      values: |
        # ============================================================
        # Weaviate Helm Chart Configuration
        # ============================================================

        # Replicas (start with 1 for MVP)
        replicas: 1

        # Image configuration
        image:
          registry: docker.io
          repo: semitechnologies/weaviate
          tag: 1.24.1

        # Resource configuration
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 1
            memory: 2Gi

        # Persistent storage configuration
        storage:
          size: 10Gi
          storageClassName: standard

        # Environment variables for Weaviate configuration
        env:
          # Enable text2vec-transformers module
          ENABLE_MODULES: "text2vec-transformers"

          # Transformers inference API
          TRANSFORMERS_INFERENCE_API: "http://weaviate-t2v-transformers:8080"

          # Default vectorizer
          DEFAULT_VECTORIZER_MODULE: "text2vec-transformers"

          # Persistence
          PERSISTENCE_DATA_PATH: "/var/lib/weaviate"

          # Query settings
          QUERY_DEFAULTS_LIMIT: "25"

          # Authentication (anonymous for MVP)
          AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: "true"

          # Cluster settings
          CLUSTER_HOSTNAME: "weaviate"
          CLUSTER_GOSSIP_BIND_PORT: "7100"
          CLUSTER_DATA_BIND_PORT: "7101"

        # text2vec-transformers module configuration
        modules:
          text2vec-transformers:
            enabled: true
            replicas: 1
            image:
              registry: docker.io
              repo: semitechnologies/transformers-inference
              tag: sentence-transformers-all-MiniLM-L6-v2
            resources:
              requests:
                cpu: 500m
                memory: 1Gi
              limits:
                cpu: 1
                memory: 2Gi
            envconfig:
              enable_cuda: "0"

        # Service configuration
        service:
          type: ClusterIP
          port: 80
          grpcPort: 50051

        # GraphQL configuration
        grpcService:
          enabled: true
          type: ClusterIP
          port: 50051

        # Ingress configuration
        ingress:
          enabled: true
          className: nginx
          annotations:
            nginx.ingress.kubernetes.io/ssl-redirect: "false"
            nginx.ingress.kubernetes.io/proxy-body-size: "100m"
            nginx.ingress.kubernetes.io/proxy-connect-timeout: "300"
            nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
            nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
          hosts:
            - host: weaviate.127.0.0.1.nip.io
              paths:
                - path: /
                  pathType: Prefix
          tls: []

        # Service account
        serviceAccount:
          create: true
          name: weaviate

        # Security context
        podSecurityContext:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000

        containerSecurityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          runAsNonRoot: true
          runAsUser: 1000
          capabilities:
            drop:
              - ALL
          seccompProfile:
            type: RuntimeDefault

        # Health probes
        livenessProbe:
          httpGet:
            path: /v1/.well-known/live
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3

        readinessProbe:
          httpGet:
            path: /v1/.well-known/ready
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        # Prometheus metrics
        monitoring:
          enabled: true

        # Affinity rules (for HA)
        affinity:
          podAntiAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 100
                podAffinityTerm:
                  labelSelector:
                    matchExpressions:
                      - key: app.kubernetes.io/name
                        operator: In
                        values:
                          - weaviate
                  topologyKey: kubernetes.io/hostname

  destination:
    server: https://kubernetes.default.svc
    namespace: fawkes

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - PrunePropagationPolicy=foreground
      - PruneLast=true
      - ServerSideApply=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

  # Keep ArgoCD from flagging differences you expect
  ignoreDifferences:
    - group: apps
      kind: Deployment
      jsonPointers:
        - /spec/replicas
    - group: apps
      kind: StatefulSet
      jsonPointers:
        - /spec/replicas

  # Basic health and retention tuning
  revisionHistoryLimit: 10
