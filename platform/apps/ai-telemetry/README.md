# AI Telemetry Dashboard

## Overview

The AI Telemetry Dashboard provides insights into AI coding assistant usage across the Fawkes platform. This is an **opt-in** system that collects aggregated metrics to measure the effectiveness and adoption of AI-powered development tools.

## Features

- **Acceptance Rate Tracking**: Percentage of AI suggestions accepted by developers
- **Code Generation Metrics**: Lines of code generated by AI assistants
- **Time Saved Estimates**: Estimated productivity improvements
- **Language Distribution**: Usage breakdown by programming language
- **User Adoption**: Number of active users and teams using AI tools

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         Developer IDEs                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │   VSCode     │  │  IntelliJ    │  │     Vim      │         │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘         │
│         │                  │                  │                  │
│         └──────────────────┴──────────────────┘                 │
│                             │                                     │
│                     (Opt-in telemetry)                           │
└─────────────────────────────┼───────────────────────────────────┘
                              │
                              │ HTTP/JSON
                              │
┌─────────────────────────────▼───────────────────────────────────┐
│                    Prometheus Pushgateway                        │
│                                                                   │
│  - Receives metrics pushes                                       │
│  - Aggregates data                                               │
│  - Exposes metrics endpoint                                      │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              │ Scrape
                              │
┌─────────────────────────────▼───────────────────────────────────┐
│                        Prometheus                                │
│                                                                   │
│  - Stores time-series metrics                                    │
│  - Provides PromQL query interface                               │
│  - Retention: 30 days                                            │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              │ Query
                              │
┌─────────────────────────────▼───────────────────────────────────┐
│                          Grafana                                 │
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │           AI Telemetry Dashboard                         │  │
│  │  - Acceptance rate gauge                                 │  │
│  │  - Lines of code chart                                   │  │
│  │  - Time saved metrics                                    │  │
│  │  - Language breakdown                                    │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## Data Collection (Opt-in)

### Privacy-First Design

**Key Principles:**

1. **Opt-in Only**: Disabled by default, users must explicitly enable
2. **Aggregated Data**: Only statistical data, no code content
3. **Anonymized**: User identifiers are hashed
4. **Retention**: Metrics retained for 90 days
5. **Transparency**: Users can view all collected data

### Metrics Collected

#### 1. AI Suggestion Acceptance Rate

```promql
# Metric: ai_copilot_suggestions_total
# Labels: user_hash, language, accepted (true/false)
ai_copilot_suggestions_total{accepted="true"} / ai_copilot_suggestions_total
```

**What it tracks:**
- Total suggestions shown
- Suggestions accepted
- Suggestions rejected
- Acceptance rate by language

**Privacy:**
- No code content
- No file names
- Aggregated by time window

#### 2. Lines of AI-Generated Code

```promql
# Metric: ai_copilot_lines_generated
# Labels: user_hash, language, date
sum(ai_copilot_lines_generated) by (language)
```

**What it tracks:**
- Number of lines accepted from AI
- Breakdown by language
- Daily/weekly trends

**Privacy:**
- Count only, no content
- Aggregated statistics

#### 3. Time Saved Estimates

```promql
# Metric: ai_copilot_time_saved_seconds
# Labels: user_hash, activity (code_completion, code_generation, documentation)
sum(ai_copilot_time_saved_seconds) / 3600  # Convert to hours
```

**What it tracks:**
- Estimated time saved based on typing speed
- Time saved by activity type
- Cumulative time savings

**Calculation:**
```
Time Saved = (Lines Generated × Average Seconds per Line) - (AI Wait Time)
Average Seconds per Line ≈ 10-15 seconds (industry standard)
```

**Privacy:**
- Statistical estimate only
- No tracking of actual work time
- Aggregated across team

#### 4. Feature Usage

```promql
# Metric: ai_copilot_feature_usage
# Labels: feature (completion, chat, explain, document, test)
sum(rate(ai_copilot_feature_usage[1h])) by (feature)
```

**What it tracks:**
- Code completion usage
- AI chat usage
- Code explanation requests
- Documentation generation
- Test generation

### Enabling Telemetry

**For Individual Developers:**

```bash
# Set environment variable
export FAWKES_AI_TELEMETRY=enabled
export FAWKES_AI_TELEMETRY_USER_ID=$(whoami | sha256sum | cut -d' ' -f1)

# Add to shell profile for persistence
echo 'export FAWKES_AI_TELEMETRY=enabled' >> ~/.bashrc
echo "export FAWKES_AI_TELEMETRY_USER_ID=$(whoami | sha256sum | cut -d' ' -f1)" >> ~/.bashrc

# Verify
echo "Telemetry enabled: $FAWKES_AI_TELEMETRY"
echo "User ID (hashed): $FAWKES_AI_TELEMETRY_USER_ID"
```

**VSCode Extension Configuration:**

Create/edit `.vscode/settings.json`:

```json
{
  "fawkes.ai.telemetry.enabled": true,
  "fawkes.ai.telemetry.endpoint": "http://pushgateway.fawkes.svc:9091",
  "fawkes.ai.telemetry.anonymize": true
}
```

### Manual Metrics Push

For developers who want to manually report metrics:

```bash
# Push acceptance metric
curl -X POST http://pushgateway.fawkes.svc:9091/metrics/job/ai_telemetry/instance/$USER_HASH \
  -d "ai_copilot_suggestions_total{language=\"python\",accepted=\"true\"} 1"

# Push lines generated
curl -X POST http://pushgateway.fawkes.svc:9091/metrics/job/ai_telemetry/instance/$USER_HASH \
  -d "ai_copilot_lines_generated{language=\"python\"} 42"

# Push time saved (in seconds)
curl -X POST http://pushgateway.fawkes.svc:9091/metrics/job/ai_telemetry/instance/$USER_HASH \
  -d "ai_copilot_time_saved_seconds{activity=\"code_completion\"} 120"
```

## Grafana Dashboard

### Accessing the Dashboard

**Local Development:**

```bash
# Port forward to Grafana
kubectl port-forward -n monitoring svc/grafana 3000:80

# Open dashboard
open http://localhost:3000/d/ai-telemetry/ai-coding-assistant-metrics
```

**Production:**

```bash
# Access via ingress
open http://grafana.fawkes.local/d/ai-telemetry/ai-coding-assistant-metrics
```

### Dashboard Panels

The AI Telemetry dashboard includes:

#### 1. Overview Panel

- **Total Suggestions**: Total AI suggestions shown
- **Acceptance Rate**: Percentage accepted (gauge)
- **Active Users**: Number of users with telemetry enabled
- **Languages**: Top 5 languages used

#### 2. Acceptance Rate Chart

Time-series graph showing:
- Overall acceptance rate
- Acceptance rate by language
- 7-day moving average

**Query:**
```promql
sum(rate(ai_copilot_suggestions_total{accepted="true"}[1h])) 
/ 
sum(rate(ai_copilot_suggestions_total[1h]))
```

#### 3. Lines of Code Generated

Stacked area chart:
- Daily lines generated
- Breakdown by language
- Cumulative total

**Query:**
```promql
sum(increase(ai_copilot_lines_generated[1d])) by (language)
```

#### 4. Time Saved Metrics

- Total time saved (hours)
- Time saved per developer
- ROI estimate

**Query:**
```promql
sum(ai_copilot_time_saved_seconds) / 3600
```

#### 5. Feature Usage Heatmap

- Most used features
- Usage by time of day
- Feature adoption trends

**Query:**
```promql
sum(rate(ai_copilot_feature_usage[1h])) by (feature)
```

### Dashboard Installation

The dashboard is automatically deployed via ArgoCD. To manually import:

```bash
# Import dashboard JSON
kubectl create configmap ai-telemetry-dashboard \
  --from-file=dashboards/ai-telemetry-dashboard.json \
  -n monitoring

# Label for Grafana discovery
kubectl label configmap ai-telemetry-dashboard \
  grafana_dashboard=1 \
  -n monitoring
```

## Configuration

### Prometheus Configuration

Add to Prometheus scrape config:

```yaml
scrape_configs:
  - job_name: 'ai-telemetry'
    honor_labels: true
    honor_timestamps: true
    scrape_interval: 30s
    scrape_timeout: 10s
    static_configs:
      - targets:
          - 'pushgateway.fawkes.svc:9091'
```

### Pushgateway Configuration

Deploy Prometheus Pushgateway (already part of Fawkes monitoring stack):

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pushgateway
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pushgateway
  template:
    metadata:
      labels:
        app: pushgateway
    spec:
      containers:
      - name: pushgateway
        image: prom/pushgateway:v1.6.0
        ports:
        - containerPort: 9091
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
```

## Usage Examples

### Example 1: Track Daily Acceptance Rate

```bash
# Calculate acceptance rate for today
kubectl port-forward -n monitoring svc/prometheus 9090:9090 &

# Query Prometheus
curl -G 'http://localhost:9090/api/v1/query' \
  --data-urlencode 'query=sum(increase(ai_copilot_suggestions_total{accepted="true"}[1d])) / sum(increase(ai_copilot_suggestions_total[1d]))' | \
  jq -r '.data.result[0].value[1]'

# Kill port forward
kill %1
```

### Example 2: Generate Weekly Report

```bash
# Script to generate weekly AI usage report
cat > /tmp/ai-weekly-report.sh << 'EOF'
#!/bin/bash
PROMETHEUS_URL="http://prometheus.monitoring.svc:9090"

echo "=== AI Coding Assistant Weekly Report ==="
echo ""

# Total suggestions
TOTAL=$(curl -s -G "${PROMETHEUS_URL}/api/v1/query" \
  --data-urlencode 'query=sum(increase(ai_copilot_suggestions_total[7d]))' | \
  jq -r '.data.result[0].value[1]')
echo "Total Suggestions: $TOTAL"

# Acceptance rate
ACCEPTANCE=$(curl -s -G "${PROMETHEUS_URL}/api/v1/query" \
  --data-urlencode 'query=sum(increase(ai_copilot_suggestions_total{accepted="true"}[7d])) / sum(increase(ai_copilot_suggestions_total[7d]))' | \
  jq -r '.data.result[0].value[1]')
echo "Acceptance Rate: $(echo "$ACCEPTANCE * 100" | bc)%"

# Lines generated
LINES=$(curl -s -G "${PROMETHEUS_URL}/api/v1/query" \
  --data-urlencode 'query=sum(increase(ai_copilot_lines_generated[7d]))' | \
  jq -r '.data.result[0].value[1]')
echo "Lines Generated: $LINES"

# Time saved (hours)
TIME_SAVED=$(curl -s -G "${PROMETHEUS_URL}/api/v1/query" \
  --data-urlencode 'query=sum(increase(ai_copilot_time_saved_seconds[7d])) / 3600' | \
  jq -r '.data.result[0].value[1]')
echo "Time Saved: $TIME_SAVED hours"
EOF

chmod +x /tmp/ai-weekly-report.sh
/tmp/ai-weekly-report.sh
```

### Example 3: Custom Alert for Low Acceptance

Create Prometheus alert for low acceptance rate:

```yaml
groups:
  - name: ai-telemetry
    interval: 5m
    rules:
      - alert: LowCopilotAcceptanceRate
        expr: |
          sum(rate(ai_copilot_suggestions_total{accepted="true"}[1h])) 
          / 
          sum(rate(ai_copilot_suggestions_total[1h])) < 0.3
        for: 2h
        labels:
          severity: warning
          component: ai-telemetry
        annotations:
          summary: "Low AI suggestion acceptance rate"
          description: "Copilot acceptance rate is {{ $value | humanizePercentage }} (below 30% threshold)"
```

## Data Retention and Privacy

### Retention Policy

```yaml
# Prometheus retention configuration
retention:
  time: 90d  # Keep metrics for 90 days
  size: 10GB # Maximum storage size
```

### Data Deletion

Users can request data deletion:

```bash
# Delete all metrics for a specific user
curl -X PUT "http://pushgateway.fawkes.svc:9091/metrics/job/ai_telemetry/instance/$USER_HASH" \
  -d ""

# Or delete from Prometheus (requires admin)
curl -X POST \
  -g "http://prometheus.monitoring.svc:9090/api/v1/admin/tsdb/delete_series?match[]=ai_copilot_suggestions_total{user_hash=\"$USER_HASH\"}"
```

### Anonymization

User identifiers are hashed before collection:

```bash
# Generate anonymized user ID
USER_HASH=$(echo -n "$USER@$HOSTNAME" | sha256sum | cut -d' ' -f1)
echo "Your anonymized ID: $USER_HASH"

# This ID cannot be reversed to identify you
```

### Compliance

- **GDPR Compliant**: Right to access and deletion
- **SOC 2**: Audit logging enabled
- **Data Minimization**: Only collect necessary metrics
- **Transparency**: All metrics documented and queryable

## Troubleshooting

### Metrics Not Appearing

**Check Pushgateway:**

```bash
# Verify pushgateway is running
kubectl get pods -n monitoring -l app=pushgateway

# Check metrics endpoint
kubectl port-forward -n monitoring svc/pushgateway 9091:9091
curl http://localhost:9091/metrics | grep ai_copilot
```

**Check Prometheus:**

```bash
# Verify Prometheus is scraping
kubectl port-forward -n monitoring svc/prometheus 9090:9090
curl 'http://localhost:9090/api/v1/targets' | jq '.data.activeTargets[] | select(.labels.job=="ai-telemetry")'
```

### Dashboard Not Loading

**Check Grafana:**

```bash
# Verify dashboard exists
kubectl get configmap -n monitoring ai-telemetry-dashboard

# Check Grafana logs
kubectl logs -n monitoring -l app.kubernetes.io/name=grafana

# Reimport dashboard
kubectl delete configmap ai-telemetry-dashboard -n monitoring
kubectl create configmap ai-telemetry-dashboard \
  --from-file=dashboards/ai-telemetry-dashboard.json \
  -n monitoring
kubectl label configmap ai-telemetry-dashboard grafana_dashboard=1 -n monitoring
```

### Telemetry Not Sending

**Verify configuration:**

```bash
# Check environment variables
echo "FAWKES_AI_TELEMETRY: $FAWKES_AI_TELEMETRY"
echo "FAWKES_AI_TELEMETRY_USER_ID: $FAWKES_AI_TELEMETRY_USER_ID"

# Test push manually
curl -X POST http://pushgateway.fawkes.svc:9091/metrics/job/ai_telemetry/instance/test \
  -d "ai_copilot_suggestions_total{language=\"test\",accepted=\"true\"} 1"

# Verify it appears
curl http://pushgateway.fawkes.svc:9091/metrics | grep ai_copilot
```

## Future Enhancements

### Planned Features

1. **Real-time Streaming**: WebSocket-based real-time metrics
2. **Team Dashboards**: Team-level aggregated views
3. **AI Model Comparison**: Compare different AI assistants (Copilot vs Continue.dev)
4. **Cost Analysis**: Track API costs and ROI
5. **Personalized Insights**: Individual developer productivity insights

### Roadmap

- **Q1 2025**: Basic telemetry and dashboard (✅ Current)
- **Q2 2025**: Team dashboards and alerts
- **Q3 2025**: Cost tracking and ROI analysis
- **Q4 2025**: ML-based insights and recommendations

## Related Documentation

- [GitHub Copilot Setup Guide](../../docs/ai/copilot-setup.md)
- [Prometheus Configuration](../prometheus/README.md)
- [Grafana Dashboards](../grafana/README.md)
- [Privacy Policy](#) *(TODO: Link to org privacy policy)*

## Support

For questions or issues:

- **Slack**: #ai-coding-help
- **Email**: platform-team@fawkes.local
- **Docs**: https://docs.fawkes.local/ai-telemetry

## License

This telemetry system is part of the Fawkes platform and follows the same license.

**Data Ownership**: All telemetry data is owned by your organization and is not shared with third parties.
