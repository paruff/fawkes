# Copyright (c) 2025  Philip Ruff
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
# IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
# DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
# OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE
# OR OTHER DEALINGS IN THE SOFTWARE.

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: feedback-automation
  namespace: fawkes
  labels:
    app: feedback-automation
    component: automation
spec:
  # Run every 15 minutes
  schedule: "*/15 * * * *"

  # Keep last 3 successful and 1 failed job for debugging
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1

  # Don't allow concurrent runs to avoid conflicts
  concurrencyPolicy: Forbid

  jobTemplate:
    metadata:
      labels:
        app: feedback-automation
        component: automation
    spec:
      # Clean up completed jobs after 1 hour
      ttlSecondsAfterFinished: 3600

      template:
        metadata:
          labels:
            app: feedback-automation
            component: automation
        spec:
          serviceAccountName: feedback-service
          restartPolicy: OnFailure

          containers:
            - name: automation
              image: curlimages/curl:latest
              imagePullPolicy: IfNotPresent

              env:
                - name: FEEDBACK_SERVICE_URL
                  value: "http://feedback-service.fawkes.svc.cluster.local:8000"
                - name: ADMIN_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: feedback-admin-token
                      key: token

              command:
                - /bin/sh
                - -c
                - |
                  echo "Starting feedback automation pipeline..."
                  echo "Timestamp: $(date)"

                  # Call automation endpoint
                  response=$(curl -s -w "\n%{http_code}" \
                    -X POST "${FEEDBACK_SERVICE_URL}/api/v1/automation/process-validated?limit=20" \
                    -H "Authorization: Bearer ${ADMIN_TOKEN}" \
                    -H "Content-Type: application/json")

                  http_code=$(echo "$response" | tail -n1)
                  body=$(echo "$response" | head -n-1)

                  echo "HTTP Status: $http_code"
                  echo "Response: $body"

                  if [ "$http_code" -eq 200 ]; then
                    echo "✅ Automation completed successfully"
                    exit 0
                  else
                    echo "❌ Automation failed with HTTP $http_code"
                    exit 1
                  fi

              resources:
                requests:
                  cpu: 10m
                  memory: 16Mi
                limits:
                  cpu: 100m
                  memory: 64Mi

              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - ALL
                readOnlyRootFilesystem: true
                runAsNonRoot: true
                runAsUser: 65534
                seccompProfile:
                  type: RuntimeDefault
