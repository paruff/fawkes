# ============================================================================
# FILE: platform/apps/prometheus/platform-components-health-dashboard.yaml
# PURPOSE: ConfigMap containing Grafana dashboard for Platform Components Health
#          monitoring (ArgoCD, Jenkins, Backstage, Harbor, PostgreSQL, etc.)
# ============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-platform-components-health
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
    app: grafana
data:
  platform-components-health.json: |
    {
      "dashboard": {
        "title": "Platform Components Health",
        "tags": ["platform", "fawkes", "health", "components"],
        "timezone": "browser",
        "schemaVersion": 38,
        "version": 1,
        "refresh": "30s",
        "description": "Monitor health and performance of Fawkes platform components including ArgoCD, Jenkins, Backstage, Harbor, and others",
        "panels": [
          {
            "id": 1,
            "title": "Platform Overview",
            "type": "row",
            "gridPos": {"x": 0, "y": 0, "w": 24, "h": 1},
            "collapsed": false
          },
          {
            "id": 2,
            "title": "ArgoCD Status",
            "type": "stat",
            "gridPos": {"x": 0, "y": 1, "w": 4, "h": 4},
            "description": "ArgoCD application controller health",
            "targets": [
              {
                "expr": "up{job=\"argocd-server-metrics\"}",
                "refId": "A",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "mappings": [
                  {"type": "value", "value": "1", "text": "UP"},
                  {"type": "value", "value": "0", "text": "DOWN"}
                ],
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "red", "value": null},
                    {"color": "green", "value": 1}
                  ]
                }
              }
            }
          },
          {
            "id": 3,
            "title": "Jenkins Status",
            "type": "stat",
            "gridPos": {"x": 4, "y": 1, "w": 4, "h": 4},
            "description": "Jenkins CI/CD server health",
            "targets": [
              {
                "expr": "up{job=\"jenkins-metrics\"}",
                "refId": "A",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "mappings": [
                  {"type": "value", "value": "1", "text": "UP"},
                  {"type": "value", "value": "0", "text": "DOWN"}
                ],
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "red", "value": null},
                    {"color": "green", "value": 1}
                  ]
                }
              }
            }
          },
          {
            "id": 4,
            "title": "Backstage Status",
            "type": "stat",
            "gridPos": {"x": 8, "y": 1, "w": 4, "h": 4},
            "description": "Backstage developer portal health",
            "targets": [
              {
                "expr": "up{job=\"backstage-metrics\"}",
                "refId": "A",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "mappings": [
                  {"type": "value", "value": "1", "text": "UP"},
                  {"type": "value", "value": "0", "text": "DOWN"}
                ],
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "red", "value": null},
                    {"color": "green", "value": 1}
                  ]
                }
              }
            }
          },
          {
            "id": 5,
            "title": "Harbor Status",
            "type": "stat",
            "gridPos": {"x": 12, "y": 1, "w": 4, "h": 4},
            "description": "Harbor container registry health",
            "targets": [
              {
                "expr": "up{job=\"harbor-core\"}",
                "refId": "A",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "mappings": [
                  {"type": "value", "value": "1", "text": "UP"},
                  {"type": "value", "value": "0", "text": "DOWN"}
                ],
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "red", "value": null},
                    {"color": "green", "value": 1}
                  ]
                }
              }
            }
          },
          {
            "id": 6,
            "title": "PostgreSQL Status",
            "type": "stat",
            "gridPos": {"x": 16, "y": 1, "w": 4, "h": 4},
            "description": "PostgreSQL database health",
            "targets": [
              {
                "expr": "up{job=\"postgresql-metrics\"}",
                "refId": "A",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "mappings": [
                  {"type": "value", "value": "1", "text": "UP"},
                  {"type": "value", "value": "0", "text": "DOWN"}
                ],
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "red", "value": null},
                    {"color": "green", "value": 1}
                  ]
                }
              }
            }
          },
          {
            "id": 7,
            "title": "OpenTelemetry Status",
            "type": "stat",
            "gridPos": {"x": 20, "y": 1, "w": 4, "h": 4},
            "description": "OpenTelemetry Collector health",
            "targets": [
              {
                "expr": "up{job=\"otel-collector-metrics\"}",
                "refId": "A",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "mappings": [
                  {"type": "value", "value": "1", "text": "UP"},
                  {"type": "value", "value": "0", "text": "DOWN"}
                ],
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "red", "value": null},
                    {"color": "green", "value": 1}
                  ]
                }
              }
            }
          },
          {
            "id": 8,
            "title": "ArgoCD Applications",
            "type": "row",
            "gridPos": {"x": 0, "y": 5, "w": 24, "h": 1},
            "collapsed": false
          },
          {
            "id": 9,
            "title": "Total Applications",
            "type": "stat",
            "gridPos": {"x": 0, "y": 6, "w": 6, "h": 4},
            "description": "Total number of ArgoCD applications",
            "targets": [
              {
                "expr": "count(argocd_app_info)",
                "refId": "A",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "short",
                "color": {"mode": "palette-classic"}
              }
            }
          },
          {
            "id": 10,
            "title": "Synced Applications",
            "type": "stat",
            "gridPos": {"x": 6, "y": 6, "w": 6, "h": 4},
            "description": "Applications in Synced state",
            "targets": [
              {
                "expr": "count(argocd_app_info{sync_status=\"Synced\"})",
                "refId": "A",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "short",
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "red", "value": null},
                    {"color": "green", "value": 1}
                  ]
                }
              }
            }
          },
          {
            "id": 11,
            "title": "Healthy Applications",
            "type": "stat",
            "gridPos": {"x": 12, "y": 6, "w": 6, "h": 4},
            "description": "Applications in Healthy state",
            "targets": [
              {
                "expr": "count(argocd_app_info{health_status=\"Healthy\"})",
                "refId": "A",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "short",
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "red", "value": null},
                    {"color": "green", "value": 1}
                  ]
                }
              }
            }
          },
          {
            "id": 12,
            "title": "Out of Sync Applications",
            "type": "stat",
            "gridPos": {"x": 18, "y": 6, "w": 6, "h": 4},
            "description": "Applications not in Synced state",
            "targets": [
              {
                "expr": "count(argocd_app_info{sync_status!=\"Synced\"})",
                "refId": "A",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "short",
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "green", "value": null},
                    {"color": "yellow", "value": 1},
                    {"color": "red", "value": 5}
                  ]
                }
              }
            }
          },
          {
            "id": 13,
            "title": "Jenkins Metrics",
            "type": "row",
            "gridPos": {"x": 0, "y": 10, "w": 24, "h": 1},
            "collapsed": false
          },
          {
            "id": 14,
            "title": "Jenkins Job Success Rate",
            "type": "gauge",
            "gridPos": {"x": 0, "y": 11, "w": 8, "h": 6},
            "description": "Percentage of successful Jenkins jobs in last hour",
            "targets": [
              {
                "expr": "sum(rate(jenkins_job_success_total[1h])) / sum(rate(jenkins_job_count_total[1h])) * 100",
                "refId": "A",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "min": 0,
                "max": 100,
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "red", "value": null},
                    {"color": "yellow", "value": 70},
                    {"color": "green", "value": 90}
                  ]
                }
              }
            }
          },
          {
            "id": 15,
            "title": "Jenkins Executor Usage",
            "type": "timeseries",
            "gridPos": {"x": 8, "y": 11, "w": 8, "h": 6},
            "description": "Jenkins executor utilization",
            "targets": [
              {
                "expr": "jenkins_executor_in_use_total",
                "refId": "A",
                "legendFormat": "In Use",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              },
              {
                "expr": "jenkins_executor_free_total",
                "refId": "B",
                "legendFormat": "Free",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "short",
                "color": {"mode": "palette-classic"},
                "custom": {
                  "drawStyle": "line",
                  "lineInterpolation": "smooth",
                  "fillOpacity": 10
                }
              }
            }
          },
          {
            "id": 16,
            "title": "Jenkins Queue Length",
            "type": "timeseries",
            "gridPos": {"x": 16, "y": 11, "w": 8, "h": 6},
            "description": "Number of jobs waiting in Jenkins queue",
            "targets": [
              {
                "expr": "jenkins_queue_size_total",
                "refId": "A",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "short",
                "color": {"mode": "palette-classic"},
                "custom": {
                  "drawStyle": "line",
                  "lineInterpolation": "smooth",
                  "fillOpacity": 10
                },
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "green", "value": null},
                    {"color": "yellow", "value": 5},
                    {"color": "red", "value": 10}
                  ]
                }
              }
            }
          },
          {
            "id": 17,
            "title": "Container Registry",
            "type": "row",
            "gridPos": {"x": 0, "y": 17, "w": 24, "h": 1},
            "collapsed": false
          },
          {
            "id": 18,
            "title": "Harbor Projects",
            "type": "stat",
            "gridPos": {"x": 0, "y": 18, "w": 6, "h": 4},
            "description": "Total number of Harbor projects",
            "targets": [
              {
                "expr": "harbor_project_total",
                "refId": "A",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "short",
                "color": {"mode": "palette-classic"}
              }
            }
          },
          {
            "id": 19,
            "title": "Harbor Repositories",
            "type": "stat",
            "gridPos": {"x": 6, "y": 18, "w": 6, "h": 4},
            "description": "Total number of repositories",
            "targets": [
              {
                "expr": "harbor_project_repo_total",
                "refId": "A",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "short",
                "color": {"mode": "palette-classic"}
              }
            }
          },
          {
            "id": 20,
            "title": "Harbor Storage Usage",
            "type": "gauge",
            "gridPos": {"x": 12, "y": 18, "w": 12, "h": 8},
            "description": "Harbor storage utilization",
            "targets": [
              {
                "expr": "(harbor_system_volumes_bytes{storage=\"registry\"} / harbor_system_volumes_total{storage=\"registry\"}) * 100",
                "refId": "A",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "min": 0,
                "max": 100,
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "green", "value": null},
                    {"color": "yellow", "value": 70},
                    {"color": "red", "value": 90}
                  ]
                }
              }
            }
          },
          {
            "id": 21,
            "title": "Harbor Scan Rate",
            "type": "timeseries",
            "gridPos": {"x": 0, "y": 22, "w": 12, "h": 6},
            "description": "Rate of vulnerability scans",
            "targets": [
              {
                "expr": "rate(harbor_artifact_scanned_total[5m])",
                "refId": "A",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "ops",
                "color": {"mode": "palette-classic"},
                "custom": {
                  "drawStyle": "line",
                  "lineInterpolation": "smooth",
                  "fillOpacity": 10
                }
              }
            }
          },
          {
            "id": 22,
            "title": "Observability Stack",
            "type": "row",
            "gridPos": {"x": 0, "y": 28, "w": 24, "h": 1},
            "collapsed": false
          },
          {
            "id": 23,
            "title": "Prometheus Targets",
            "type": "stat",
            "gridPos": {"x": 0, "y": 29, "w": 6, "h": 4},
            "description": "Active Prometheus scrape targets",
            "targets": [
              {
                "expr": "sum(up)",
                "refId": "A",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "short",
                "color": {"mode": "palette-classic"}
              }
            }
          },
          {
            "id": 24,
            "title": "Prometheus TSDB Size",
            "type": "gauge",
            "gridPos": {"x": 6, "y": 29, "w": 6, "h": 4},
            "description": "Prometheus time-series database size",
            "targets": [
              {
                "expr": "prometheus_tsdb_storage_blocks_bytes / 1024 / 1024 / 1024",
                "refId": "A",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "decgbytes",
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "green", "value": null},
                    {"color": "yellow", "value": 15},
                    {"color": "red", "value": 20}
                  ]
                }
              }
            }
          },
          {
            "id": 25,
            "title": "OpenTelemetry Traces Received",
            "type": "timeseries",
            "gridPos": {"x": 12, "y": 29, "w": 12, "h": 6},
            "description": "Rate of traces received by OpenTelemetry Collector",
            "targets": [
              {
                "expr": "rate(otelcol_receiver_accepted_spans[5m])",
                "refId": "A",
                "legendFormat": "{{receiver}}",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "spansps",
                "color": {"mode": "palette-classic"},
                "custom": {
                  "drawStyle": "line",
                  "lineInterpolation": "smooth",
                  "fillOpacity": 10
                }
              }
            }
          },
          {
            "id": 26,
            "title": "Component Response Times",
            "type": "timeseries",
            "gridPos": {"x": 0, "y": 33, "w": 24, "h": 8},
            "description": "Response time (P95) for platform components",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, sum by (le, job) (rate(http_request_duration_seconds_bucket{job=~\"argocd-server-metrics|jenkins-metrics|backstage-metrics\"}[5m])))",
                "refId": "A",
                "legendFormat": "{{job}}",
                "datasource": {"type": "prometheus", "uid": "prometheus"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "s",
                "color": {"mode": "palette-classic"},
                "custom": {
                  "drawStyle": "line",
                  "lineInterpolation": "smooth",
                  "fillOpacity": 10
                },
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "green", "value": null},
                    {"color": "yellow", "value": 1},
                    {"color": "red", "value": 3}
                  ]
                }
              }
            }
          }
        ],
        "templating": {
          "list": [
            {
              "name": "datasource",
              "type": "datasource",
              "query": "prometheus",
              "current": {
                "value": "prometheus",
                "text": "Prometheus"
              }
            }
          ]
        },
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "timepicker": {
          "refresh_intervals": ["10s", "30s", "1m", "5m", "15m", "30m"]
        }
      }
    }
