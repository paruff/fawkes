# ============================================================
# DevLake Helm Values for Fawkes Platform
# Apache DevLake for DORA Metrics Collection and Visualization
# ============================================================
# Usage: helm install devlake apache/devlake -f values.yaml -n fawkes-devlake
#
# For more configuration options, see:
# https://devlake.apache.org/docs/GettingStarted/HelmSetup
# ============================================================

# ============================================================
# DORA Metrics Configuration
# Enables and configures the five core DORA metrics
# ============================================================
config:
  metrics:
    # Enable DORA metrics calculation
    dora: true

    # Metric 1: Deployment Frequency
    # Measures how often code is deployed to production
    deploymentFrequency:
      enabled: true
      window: 7  # Rolling window in days
      # Targets for DORA performance levels:
      # Elite: Multiple deploys per day
      # High: Between once per day and once per week
      # Medium: Between once per week and once per month
      # Low: Less than once per month

    # Metric 2: Lead Time for Changes
    # Measures time from code commit to production deployment
    leadTime:
      enabled: true
      stages:
        - development   # Time in development
        - review        # Time in code review
        - production    # Time to production deploy
      # Targets for DORA performance levels:
      # Elite: Less than one hour
      # High: Less than one day
      # Medium: Less than one week
      # Low: More than one week

    # Metric 3: Change Failure Rate (CFR)
    # Percentage of deployments causing production incidents
    changeFailureRate:
      enabled: true
      window: 30  # Rolling window in days
      # Targets for DORA performance levels:
      # Elite: 0-5%
      # High: 5-10%
      # Medium: 10-15%
      # Low: 15-100%

    # Metric 4: Mean Time to Restore (MTTR)
    # Average time to restore service after incident
    timeToRestore:
      enabled: true
      severityLevels:
        - high    # Critical incidents
        - medium  # Major incidents
        - low     # Minor incidents
      # Targets for DORA performance levels:
      # Elite: Less than one hour
      # High: Less than one day
      # Medium: Less than one week
      # Low: More than one week

    # Metric 5: Operational Performance (Reliability)
    # Tracks SLO/SLI adherence for service reliability
    operationalPerformance:
      enabled: true
      sloTarget: 99.9        # Target SLO percentage
      latencyP99Threshold: 500   # P99 latency in ms
      errorRateThreshold: 0.1    # Error rate percentage

# ============================================================
# Grafana Configuration for DORA Dashboards
# ============================================================
grafana:
  enabled: true

  image:
    repository: grafana/grafana
    tag: "10.2.2"

  adminUser: admin
  # NOTE: In production, use Vault/ExternalSecrets for credentials
  # Reference: platform/apps/devlake/config/data-sources.yaml
  adminPassword: "fawkesidp"

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Pre-configured DORA dashboards
  dashboards:
    dora:
      enabled: true

  # Ingress for Grafana access
  ingress:
    enabled: true
    hosts:
      - devlake-grafana.127.0.0.1.nip.io

# ============================================================
# MySQL Database Configuration
# ============================================================
mysql:
  enabled: true

  image:
    repository: mysql
    tag: "8.0"

  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 4Gi

  persistence:
    enabled: true
    size: 20Gi
    storageClass: ""  # Uses default storage class

  auth:
    # NOTE: In production, use Vault/ExternalSecrets for credentials
    # Reference: platform/apps/devlake/config/data-sources.yaml
    database: lake
    username: devlake
    existingSecret: devlake-mysql-secrets
    secretKeys:
      rootPassword: mysql-root-password
      password: mysql-password

# ============================================================
# DevLake API Server Configuration
# ============================================================
lake:
  image:
    repository: apache/devlake
    tag: v1.0.1
    pullPolicy: IfNotPresent

  replicas: 1

  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 2Gi

  # Environment variables
  envs:
    - name: PORT
      value: "8080"
    - name: LOGGING_LEVEL
      value: "info"
    - name: ENCRYPTION_SECRET
      valueFrom:
        secretKeyRef:
          name: devlake-secrets
          key: encryption-secret

# ============================================================
# DevLake UI Configuration
# ============================================================
ui:
  image:
    repository: apache/devlake-config-ui
    tag: v1.0.1
    pullPolicy: IfNotPresent

  replicas: 1

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

# ============================================================
# Service Configuration
# ============================================================
service:
  type: ClusterIP
  lake:
    port: 8080
  ui:
    port: 4000
  grafana:
    port: 3000

# ============================================================
# Ingress Configuration
# ============================================================
ingress:
  enabled: true
  className: nginx
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: 100m
  hosts:
    - host: devlake.127.0.0.1.nip.io
      paths:
        - path: /api
          pathType: Prefix
          service: lake
        - path: /
          pathType: Prefix
          service: ui
    - host: devlake-grafana.127.0.0.1.nip.io
      paths:
        - path: /
          pathType: Prefix
          service: grafana

# ============================================================
# Security Context
# ============================================================
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

# ============================================================
# Pod Labels and Annotations
# ============================================================
podLabels:
  app.kubernetes.io/part-of: fawkes-platform
  app.kubernetes.io/component: dora-metrics

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8080"
  prometheus.io/path: "/metrics"

# ============================================================
# Data Source Connections
# Configured via External Secrets for security
# See: platform/apps/devlake/config/data-sources.yaml
# ============================================================
connections:
  github:
    enabled: true
    # Token managed via External Secrets
  jenkins:
    enabled: true
    # Credentials managed via External Secrets
  webhook:
    enabled: true
    # For incident/deployment events
