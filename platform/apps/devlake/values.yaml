# Copyright (c) 2025  Philip Ruff
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
# IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
# DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
# OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE
# OR OTHER DEALINGS IN THE SOFTWARE.

# ============================================================
# DevLake Helm Values for Fawkes Platform
# Apache DevLake for DORA Metrics Collection and Visualization
# ============================================================
# SECURITY: Database credentials are managed via External Secrets
# See: platform/apps/devlake/externalsecret-devlake.yaml
# ============================================================

config:
  metrics:
    # Enable DORA metrics calculation
    dora: true

    # Metric 1: Deployment Frequency
    # Measures how often code is deployed to production
    deploymentFrequency:
      enabled: true
      window: 7 # days
    leadTime:
      enabled: true
      stages:
        - development # Time in development
        - review # Time in code review
        - production # Time to production deploy
      # Targets for DORA performance levels:
      # Elite: Less than one hour
      # High: Less than one day
      # Medium: Less than one week
      # Low: More than one week

    # Metric 3: Change Failure Rate (CFR)
    # Percentage of deployments causing production incidents
    changeFailureRate:
      enabled: true
      window: 30 # days
    timeToRestore:
      enabled: true
      severityLevels:
        - high # Critical incidents
        - medium # Major incidents
        - low # Minor incidents
      # Targets for DORA performance levels:
      # Elite: Less than one hour
      # High: Less than one day
      # Medium: Less than one week
      # Low: More than one week

    # Metric 5: Operational Performance (Reliability)
    # Tracks SLO/SLI adherence for service reliability
    operationalPerformance:
      enabled: true
      sloTarget: 99.9 # Target SLO percentage
      latencyP99Threshold: 500 # P99 latency in ms
      errorRateThreshold: 0.1 # Error rate percentage

# ============================================================
# Grafana Configuration for DORA Dashboards
# ============================================================
grafana:
  enabled: true

  image:
    repository: grafana/grafana
    tag: "10.2.2"

  adminUser: admin
  # Grafana admin password from Kubernetes secret (managed by External Secrets)
  # See: platform/apps/devlake/externalsecret-devlake.yaml
  adminPasswordSecretName: devlake-grafana-secrets
  adminPasswordSecretKey: admin-password

  # Ingress for Grafana access
  ingress:
    enabled: true
    hosts:
      - devlake-grafana.127.0.0.1.nip.io

# ============================================================
# MySQL Database Configuration
# ============================================================
mysql:
  enabled: true

  image:
    repository: mysql
    tag: "8.0"

  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 4Gi

  persistence:
    enabled: true
    size: 20Gi
    storageClass: "" # Uses default storage class

  auth:
    # Database credentials from Kubernetes secret (managed by External Secrets)
    # See: platform/apps/devlake/externalsecret-devlake.yaml
    database: devlake
    username: devlake
    existingSecret: devlake-mysql-secrets
    secretKeys:
      rootPassword: mysql-root-password
      password: mysql-password
