apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: devlake
  namespace: fawkes
spec:
  project: default
  source:
    repoURL: https://apache.github.io/incubator-devlake-helm-chart
    chart: devlake
    targetRevision: 1.0.1
    helm:
      values: |
        # ============================================================
        # DevLake Core Configuration
        # Apache DevLake for DORA Metrics Collection and Visualization
        # ============================================================

        # Namespace for DevLake deployment
        namespace: fawkes

        # ============================================================
        # DevLake API Server Configuration
        # ============================================================
        lake:
          image:
            repository: apache/devlake
            tag: v1.0.1
            pullPolicy: IfNotPresent

          replicas: 1

          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 2Gi

          # Use secret references for sensitive values
          extraEnv:
          - name: ENCRYPTION_SECRET
            valueFrom:
              secretKeyRef:
                name: devlake-secrets
                key: encryption-secret

        # ============================================================
        # DevLake UI Configuration
        # ============================================================
        ui:
          image:
            repository: apache/devlake-config-ui
            tag: v1.0.1
            pullPolicy: IfNotPresent

          replicas: 1

          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi

        # ============================================================
        # Grafana Configuration for DORA Dashboards
        # ============================================================
        grafana:
          enabled: true
          image:
            repository: grafana/grafana
            tag: 10.2.2
            pullPolicy: IfNotPresent
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          # Admin credentials sourced from Secret (no inline password)
          adminUser: admin
          adminPasswordSecretName: devlake-grafana-secrets
          adminPasswordSecretKey: admin-password
          dashboards:
            enabled: true
            dora:
              enabled: true

        # ============================================================
        # MySQL Database Configuration
        # ============================================================
        mysql:
          enabled: true
          image:
            repository: mysql
            tag: "8.0"
            pullPolicy: IfNotPresent
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 4Gi
          persistence:
            enabled: true
            storageClass: ""
            size: 20Gi
          # Database credentials: reference External Secret, no inline values
          auth:
            database: lake
            username: devlake
            existingSecret: devlake-db
            secretKeys:
              rootPassword: mysql-root-password
              password: mysql-password

        # ============================================================
        # Service Configuration
        # ============================================================
        service:
          type: ClusterIP
          lake:
            port: 8080
          ui:
            port: 4000
          grafana:
            port: 3000

        # ============================================================
        # Ingress Configuration
        # ============================================================
        ingress:
          enabled: true
          className: nginx
          annotations:
            nginx.ingress.kubernetes.io/proxy-body-size: 100m
          hosts:
            - host: devlake.127.0.0.1.nip.io
              paths:
                - path: /api
                  pathType: Prefix
                  service: lake
                - path: /
                  pathType: Prefix
                  service: ui
            - host: devlake-grafana.127.0.0.1.nip.io
              paths:
                - path: /
                  pathType: Prefix
                  service: grafana

        # ============================================================
        # DORA Metrics Configuration
        # ============================================================
        config:
          metrics:
            dora: true
            deploymentFrequency:
              enabled: true
              window: 7
            leadTime:
              enabled: true
              stages:
                - development
                - review
                - production
            changeFailureRate:
              enabled: true
              window: 30
            timeToRestore:
              enabled: true
              severityLevels:
                - high
                - medium
                - low
            operationalPerformance:
              enabled: true
              sloTarget: 99.9

        # ============================================================
        # Security Context
        # ============================================================
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          fsGroup: 1000

        # ============================================================
        # Pod Labels and Annotations
        # ============================================================
        podLabels:
          app.kubernetes.io/part-of: fawkes-platform
          app.kubernetes.io/component: dora-metrics
        podAnnotations:
          prometheus.io/scrape: "true"
          prometheus.io/port: "8080"
          prometheus.io/path: "/metrics"
  destination:
    server: https://kubernetes.default.svc
    namespace: fawkes
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true