# ============================================================================
# FILE: platform/apps/devlake/externalsecret-devlake.yaml
# PURPOSE: ExternalSecret to pull DevLake database and Grafana credentials
#          from secret manager via External Secrets Operator.
# USAGE: Configure Vault/AWS Secrets Manager/Azure Key Vault with these secrets:
#        - devlake/mysql/root-password
#        - devlake/mysql/password
#        - devlake/grafana/admin-password
# ============================================================================
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: devlake-mysql-credentials
  namespace: fawkes-devlake
  labels:
    app: devlake
    component: database
    team: platform
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager  # or azure-keyvault; patch per environment
    kind: ClusterSecretStore
  target:
    name: devlake-mysql-secrets
    creationPolicy: Owner
  data:
    - secretKey: mysql-root-password
      remoteRef:
        key: devlake/mysql
        property: root-password
    - secretKey: mysql-password
      remoteRef:
        key: devlake/mysql
        property: password
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: devlake-grafana-credentials
  namespace: fawkes-devlake
  labels:
    app: devlake
    component: grafana
    team: platform
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager  # or azure-keyvault; patch per environment
    kind: ClusterSecretStore
  target:
    name: devlake-grafana-secrets
    creationPolicy: Owner
  data:
    - secretKey: admin-password
      remoteRef:
        key: devlake/grafana
        property: admin-password
