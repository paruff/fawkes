# ============================================================================
# FILE: platform/apps/jenkins/jenkins-casc-configmap.yaml
# PURPOSE: Kubernetes ConfigMap containing Jenkins Configuration as Code
# ============================================================================
# NOTE: This ConfigMap is provided as a reference implementation.
# The active JCasC configuration is embedded in jenkins-application.yaml
# for single-source deployment via ArgoCD.
#
# For standalone Helm deployments (without ArgoCD), use this ConfigMap:
#   kubectl apply -f platform/apps/jenkins/jenkins-casc-configmap.yaml
#
# For the canonical JCasC source, see: platform/apps/jenkins/jcasc.yaml
# ============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: jenkins-casc
  namespace: fawkes
  labels:
    app: jenkins
    component: ci-cd
    team: platform
  annotations:
    fawkes.io/managed-by: "argocd"
    fawkes.io/description: "Jenkins Configuration as Code (reference)"
data:
  jcasc.yaml: |
    # ============================================================================
    # Jenkins Configuration as Code (JCasC)
    # Purpose: Reproducible Jenkins configuration for Fawkes CI/CD Platform
    # ============================================================================
    # This file defines Jenkins configuration declaratively, eliminating the need
    # for manual UI-based configuration. All settings are version-controlled and
    # can be applied automatically on Jenkins startup.
    #
    # Key Benefits:
    # - Reproducible configuration across environments
    # - Version-controlled changes with Git history
    # - Automated configuration on container restart
    # - No manual UI clicks required
    # - Easy disaster recovery
    #
    # Configuration Categories:
    # 1. Jenkins Core Settings (system message, executors, security)
    # 2. Kubernetes Cloud (dynamic agent provisioning)
    # 3. Credentials (GitHub, SonarQube, Docker)
    # 4. Tool Installations (Git, Maven, Node.js)
    # 5. Global Libraries (Fawkes pipeline library)
    # 6. Integration Plugins (SonarQube, Mattermost)
    # ============================================================================

    jenkins:
      systemMessage: "Fawkes CI/CD Platform - Golden Path Enabled"
      mode: NORMAL
      # numExecutors: 0 prevents builds from running on the controller node
      # for security and resource isolation - all builds run on Kubernetes agents
      numExecutors: 0

      # ============================================================================
      # Kubernetes Cloud Configuration
      # ============================================================================
      # Dynamic agent provisioning using Kubernetes plugin
      # - Creates ephemeral pods for each build
      # - Automatically scales based on demand
      # - Destroys pods after build completion
      # - Resource-efficient and secure
      clouds:
        - kubernetes:
            name: "kubernetes"
            namespace: "fawkes"
            jenkinsUrl: "http://jenkins:8080"
            jenkinsTunnel: "jenkins-agent:50000"
            containerCapStr: "20"  # Maximum concurrent Kubernetes pods
            connectTimeout: 30
            readTimeout: 15
            maxRequestsPerHostStr: "32"
            retentionTimeout: 5
            templates:
              # Default JNLP agent
              - name: "jnlp-agent"
                label: "k8s-agent"
                remoteFs: "/home/jenkins"
                instanceCapStr: "10"
                idleTerminationMinutes: 10
                containers:
                  - name: "jnlp"
                    image: "jenkins/inbound-agent:latest"
                    args: "${computer.jnlpmac} ${computer.name}"
                    workingDir: "/home/jenkins"

              # Maven agent for Java builds
              - name: "maven-agent"
                label: "maven java"
                remoteFs: "/home/jenkins"
                instanceCapStr: "5"
                idleTerminationMinutes: 10
                containers:
                  - name: "maven"
                    image: "maven:3.9-eclipse-temurin-17"
                    command: "cat"
                    ttyEnabled: true
                    resourceRequestCpu: "1"
                    resourceRequestMemory: "2Gi"
                    resourceLimitCpu: "2"
                    resourceLimitMemory: "4Gi"
                  - name: "jnlp"
                    image: "jenkins/inbound-agent:latest"
                    args: "${computer.jnlpmac} ${computer.name}"

              # Python agent
              - name: "python-agent"
                label: "python"
                remoteFs: "/home/jenkins"
                instanceCapStr: "5"
                idleTerminationMinutes: 10
                containers:
                  - name: "python"
                    image: "python:3.11-slim"
                    command: "cat"
                    ttyEnabled: true
                    resourceRequestCpu: "500m"
                    resourceRequestMemory: "1Gi"
                    resourceLimitCpu: "1"
                    resourceLimitMemory: "2Gi"
                  - name: "jnlp"
                    image: "jenkins/inbound-agent:latest"
                    args: "${computer.jnlpmac} ${computer.name}"

              # Node.js agent
              - name: "node-agent"
                label: "node nodejs"
                remoteFs: "/home/jenkins"
                instanceCapStr: "5"
                idleTerminationMinutes: 10
                containers:
                  - name: "node"
                    image: "node:20-slim"
                    command: "cat"
                    ttyEnabled: true
                    resourceRequestCpu: "500m"
                    resourceRequestMemory: "1Gi"
                    resourceLimitCpu: "1"
                    resourceLimitMemory: "2Gi"
                  - name: "jnlp"
                    image: "jenkins/inbound-agent:latest"
                    args: "${computer.jnlpmac} ${computer.name}"

              # Go agent
              - name: "go-agent"
                label: "go golang"
                remoteFs: "/home/jenkins"
                instanceCapStr: "5"
                idleTerminationMinutes: 10
                containers:
                  - name: "golang"
                    image: "golang:1.21"
                    command: "cat"
                    ttyEnabled: true
                    resourceRequestCpu: "500m"
                    resourceRequestMemory: "1Gi"
                    resourceLimitCpu: "1"
                    resourceLimitMemory: "2Gi"
                  - name: "jnlp"
                    image: "jenkins/inbound-agent:latest"
                    args: "${computer.jnlpmac} ${computer.name}"

    securityRealm:
      local:
        allowsSignup: false
        users:
          - id: "admin"
            password: "${ADMIN_PASSWORD}"  # injected from k8s Secret

    authorizationStrategy:
      loggedInUsersCanDoAnything:
        allowAnonymousRead: false

    # ============================================================================
    # Credentials Configuration
    # ============================================================================
    # Credentials are sourced from Kubernetes Secrets for security
    # In production, use External Secrets Operator to sync from Vault/AWS/Azure
    #
    # Required Secrets in Kubernetes:
    # - jenkins-github-credentials (for repository access, webhooks)
    # - jenkins-sonarqube-credentials (for code quality integration)
    # - jenkins-docker-credentials (for container registry push)
    #
    # To create secrets:
    #   kubectl apply -f platform/apps/jenkins/secrets.yaml
    #
    # For production with External Secrets Operator:
    #   kubectl apply -f platform/apps/external-secrets/externalsecret-jenkins-*.yaml
    credentials:
      system:
        domainCredentials:
          - credentials:
              # GitHub Personal Access Token for repository access
              - string:
                  scope: GLOBAL
                  id: "github-token"
                  secret: "${GITHUB_TOKEN}"
                  description: "GitHub Personal Access Token for repository access and webhooks"

              # SonarQube authentication token
              - string:
                  scope: GLOBAL
                  id: "sonarqube-token"
                  secret: "${SONARQUBE_TOKEN}"
                  description: "SonarQube token for code quality scanning"

              # Docker registry credentials (Harbor)
              - usernamePassword:
                  scope: GLOBAL
                  id: "docker-registry"
                  username: "${DOCKER_REGISTRY_USERNAME}"
                  password: "${DOCKER_REGISTRY_PASSWORD}"
                  description: "Docker registry credentials for image push"

              # GitHub App credentials (alternative to PAT for enterprise)
              # Uncomment when GitHub App is configured
              # - gitHubApp:
              #     scope: GLOBAL
              #     id: "github-app"
              #     appID: "${GITHUB_APP_ID}"
              #     privateKey: "${GITHUB_APP_PRIVATE_KEY}"
              #     description: "GitHub App for enhanced security and API rate limits"

    unclassified:
      location:
        adminAddress: "ci-admin@fawkes.local"
        url: "http://jenkins.127.0.0.1.nip.io"

      # Global Shared Library Configuration for Golden Path
      globalLibraries:
        libraries:
          - name: "fawkes-pipeline-library"
            defaultVersion: "main"
            implicit: true
            allowVersionOverride: true
            retriever:
              modernSCM:
                scm:
                  git:
                    remote: "https://github.com/paruff/fawkes"
                    credentialsId: "github-token"
                libraryPath: "jenkins-shared-library"

      # SonarQube configuration (for code quality gates)
      sonarGlobalConfiguration:
        buildWrapperEnabled: true
        installations:
          - name: "SonarQube"
            serverUrl: "http://sonarqube.fawkes.svc:9000"
            credentialsId: "sonarqube-token"

      # Mattermost notification configuration
      mattermostNotifier:
        endpoint: "http://mattermost.fawkes.svc:8065/hooks/jenkins"
        room: "ci-builds"
        icon: ":jenkins:"
        buildServerUrl: "http://jenkins.127.0.0.1.nip.io"

    # ============================================================================
    # Security Configuration
    # ============================================================================
    # Script approval whitelist for pipeline security
    # Only approved methods can be called from pipeline scripts
    #
    # SECURITY NOTE: Be cautious when approving methods that access environment
    # variables (e.g., System.getenv) as they could expose sensitive information.
    # Only approve if necessary for legitimate pipeline use cases.
    security:
      scriptApproval:
        approvedSignatures:
          - "method groovy.lang.GroovyObject invokeMethod java.lang.String java.lang.Object"
          - "staticMethod org.codehaus.groovy.runtime.DefaultGroovyMethods take java.lang.CharSequence int"
          # Add more as needed for pipeline scripts
          - "method java.util.Properties getProperty java.lang.String"
          # Environment access - use carefully, consider alternatives like credentials binding
          - "staticMethod java.lang.System getenv java.lang.String"

    # ============================================================================
    # Tool Installations
    # ============================================================================
    # Automatic installation of build tools
    # Tools are installed on-demand on agents during first use
    tool:
      git:
        installations:
          - name: "Default"
            home: "git"

      maven:
        installations:
          - name: "Maven 3.9"
            properties:
              - installSource:
                  installers:
                    - maven:
                        id: "3.9.6"

      # Additional tools can be added here:
      # nodejs, jdk, gradle, etc.
      # Example:
      # nodejs:
      #   installations:
      #     - name: "Node 20"
      #       properties:
      #         - installSource:
      #             installers:
      #               - nodeJSInstaller:
      #                   id: "20.10.0"

    # ============================================================================
    # Required Plugins Configuration
    # ============================================================================
    # NOTE: Plugins are installed via Helm values in jenkins-application.yaml
    # The following plugins are REQUIRED for this JCasC configuration to work:
    #
    # Core Pipeline Plugins:
    # - kubernetes                    # Kubernetes plugin for dynamic agents
    # - workflow-aggregator           # Pipeline suite
    # - workflow-job                  # Pipeline job type
    # - workflow-multibranch          # Multi-branch pipeline support
    # - pipeline-stage-view           # Pipeline visualization
    # - pipeline-utility-steps        # Additional pipeline steps
    #
    # Source Control Management:
    # - git                           # Git plugin
    # - github                        # GitHub integration
    # - github-branch-source          # GitHub branch discovery
    #
    # Credentials & Security:
    # - credentials-binding           # Credentials in environment variables
    # - credentials                   # Core credentials functionality
    #
    # Configuration as Code:
    # - configuration-as-code         # JCasC plugin (REQUIRED)
    #
    # Shared Libraries:
    # - pipeline-github-lib           # GitHub shared libraries
    #
    # Quality & Testing:
    # - junit                         # JUnit test results
    # - jacoco                        # Code coverage
    # - warnings-ng                   # Static analysis results
    # - htmlpublisher                 # HTML reports
    # - cucumber-reports              # BDD test reports
    #
    # Security Scanning:
    # - sonar                         # SonarQube integration
    #
    # Notifications:
    # - mattermost                    # Mattermost notifications
    # - email-ext                     # Extended email notifications
    #
    # Kubernetes Integration:
    # - kubernetes-cli                # kubectl in pipelines
    #
    # Build Tools:
    # - maven-plugin                  # Maven support
    # - nodejs                        # Node.js support
    #
    # Utilities:
    # - http_request                  # HTTP request step
    # - pipeline-input-step           # Manual approval
    # - docker-workflow               # Docker pipeline steps
    # - timestamper                   # Timestamp console output
    # - ansicolor                     # ANSI color output
    # - build-discarder               # Automatic build cleanup
    #
    # Plugin Installation:
    # Plugins are installed automatically via Helm chart values:
    #   controller:
    #     installPlugins:
    #       - kubernetes:latest
    #       - workflow-aggregator:latest
    #       ... (see jenkins-application.yaml for full list)
    #
    # For manual plugin management (not recommended):
    #   1. Add plugin to jenkins-application.yaml installPlugins list
    #   2. Sync ArgoCD application: argocd app sync jenkins
    #   3. Jenkins will restart with new plugins
    #
    # Plugin Version Management:
    # - Use "latest" for automatic updates (recommended for development)
    # - Pin specific versions for production stability
    #   Example: kubernetes:4029.v5712230ccb_f8
    #
    # Verify Plugin Installation:
    # After deployment, verify plugins are installed:
    #   kubectl exec -n fawkes jenkins-0 -- jenkins-plugin-cli --list
    #
    # ============================================================================
