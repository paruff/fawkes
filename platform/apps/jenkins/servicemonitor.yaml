# ============================================================================
# FILE: platform/jenkins/servicemonitor.yaml
# PURPOSE: Prometheus monitoring configuration
# ============================================================================
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: jenkins
  namespace: jenkins
  labels:
    app: jenkins
    release: prometheus
spec:
  selector:
    matchLabels:
      app.kubernetes.io/component: jenkins-controller
  endpoints:
    - port: http
      path: /prometheus
      interval: 30s
      scrapeTimeout: 10s
      scheme: http

---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: jenkins-alerts
  namespace: jenkins
  labels:
    app: jenkins
    release: prometheus
spec:
  groups:
    - name: jenkins.rules
      interval: 30s
      rules:
        # Controller health
        - alert: JenkinsDown
          expr: up{job="jenkins"} == 0
          for: 5m
          labels:
            severity: critical
            component: jenkins
          annotations:
            summary: "Jenkins controller is down"
            description: "Jenkins controller has been down for more than 5 minutes"
        
        # High queue length
        - alert: JenkinsHighQueueLength
          expr: jenkins_queue_size_value > 10
          for: 10m
          labels:
            severity: warning
            component: jenkins
          annotations:
            summary: "Jenkins has high queue length"
            description: "Jenkins queue has {{ $value }} items waiting for more than 10 minutes"
        
        # Executor saturation
        - alert: JenkinsExecutorsSaturated
          expr: (jenkins_executor_in_use_value / jenkins_executor_count_value) > 0.9
          for: 15m
          labels:
            severity: warning
            component: jenkins
          annotations:
            summary: "Jenkins executors are saturated"
            description: "Jenkins is using {{ $value | humanizePercentage }} of available executors"
        
        # Failed jobs
        - alert: JenkinsHighJobFailureRate
          expr: rate(jenkins_builds_failed_build_count_total[5m]) > 0.1
          for: 10m
          labels:
            severity: warning
            component: jenkins
          annotations:
            summary: "High job failure rate in Jenkins"
            description: "Jenkins job failure rate is {{ $value | humanize }} jobs/second"
        
        # Disk space
        - alert: JenkinsDiskSpacelow
          expr: jenkins_node_disk_space_free_bytes / jenkins_node_disk_space_total_bytes < 0.1
          for: 5m
          labels:
            severity: warning
            component: jenkins
          annotations:
            summary: "Jenkins is running low on disk space"
            description: "Jenkins has less than 10% disk space remaining"
        
        # Memory usage
        - alert: JenkinsHighMemoryUsage
          expr: (jenkins_memory_total_used_bytes / jenkins_memory_total_max_bytes) > 0.9
          for: 10m
          labels:
            severity: warning
            component: jenkins
          annotations:
            summary: "Jenkins memory usage is high"
            description: "Jenkins is using {{ $value | humanizePercentage }} of allocated memory"

